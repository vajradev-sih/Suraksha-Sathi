<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MineSafe - Training Officer Dashboard</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Material Symbols -->
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,0..200"
        rel="stylesheet" />

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&display=swap" rel="stylesheet">

    <!-- API Client -->
    <script src="../api.client.js"></script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0284c7",
                        "primary-dark": "#0369a1",
                        "primary-light": "#7dd3fc",
                        "secondary": "#f97316",
                        "background-light": "#f8fafc",
                        "surface-light": "#ffffff",
                        "surface-light-alt": "#f1f5f9",
                        "safety-yellow": "#facc15",
                        "safety-orange": "#f97316",
                        "alert-red": "#ef4444",
                        "success-green": "#22c55e",
                        "neutral-50": "#f8fafc",
                        "neutral-100": "#f1f5f9",
                        "neutral-200": "#e2e8f0",
                        "neutral-300": "#cbd5e1",
                        "neutral-400": "#94a3b8",
                        "neutral-500": "#64748b",
                        "neutral-600": "#475569",
                        "neutral-700": "#334155",
                        "neutral-800": "#1e293b",
                        "neutral-900": "#0f172a",
                    },
                    fontFamily: {
                        "sans": ["Inter", "sans-serif"],
                        "orbitron": ["Orbitron", "sans-serif"],
                    },
                    borderRadius: {
                        "4xl": "2rem",
                    },
                    boxShadow: {
                        'card': '0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 1px 2px -1px rgba(0, 0, 0, 0.03)',
                        'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.03)',
                    },
                },
            },
        };
    </script>

    <style>
        .material-symbols-rounded {
            font-variation-settings: "FILL" 1, "wght" 400, "GRAD" 0, "opsz" 24;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Animation classes */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .slide-in-up {
            animation: slideInUp 0.4s ease-out;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .pulse-slow {
            animation: pulseSlow 2s ease-in-out infinite;
        }

        @keyframes pulseSlow {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .upload-icon-animate {
            animation: uploadBounce 0.6s ease-in-out;
        }

        @keyframes uploadBounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-8px);
            }
        }

        /* Range Slider Fixes */
        input[type=range] {
            pointer-events: none;
        }

        input[type=range]::-webkit-slider-thumb {
            pointer-events: auto;
            cursor: pointer;
            width: 16px;
            height: 16px;
            -webkit-appearance: none;
            background: white;
            border: 2px solid #0284c7;
            border-radius: 50%;
            margin-top: -6px;
            /* Adjust for track height */
        }

        input[type=range]::-moz-range-thumb {
            pointer-events: auto;
            cursor: pointer;
            width: 16px;
            height: 16px;
            background: white;
            border: 2px solid #0284c7;
            border-radius: 50%;
        }

        /* Free Form Crop Overlay */
        .crop-overlay-free {
            resize: both;
            overflow: hidden;
            min-width: 50px;
            min-height: 50px;
            max-width: 100%;
            max-height: 100%;
            pointer-events: auto !important;
        }
    </style>
</head>

<body class="bg-neutral-100 text-neutral-800 h-screen flex flex-col overflow-hidden font-sans">

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">

        <!-- Header -->
        <header
            class="h-16 bg-white border-b border-neutral-200 flex items-center justify-between px-6 shrink-0 shadow-sm">
            <h2 id="page-title" class="text-xl font-bold text-neutral-800">Training Modules</h2>

            <div class="flex items-center gap-4">
                <div class="relative hidden md:block">
                    <span
                        class="material-symbols-rounded absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400 text-xl">search</span>
                    <input type="text" placeholder="Search modules..."
                        class="pl-10 pr-4 py-2 border border-neutral-300 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-primary w-64 bg-neutral-50">
                </div>
                <button class="relative p-2 text-neutral-500 hover:bg-neutral-100 rounded-full transition-colors">
                    <span class="material-symbols-rounded pulse-slow">notifications</span>
                    <span class="absolute top-1 right-1 w-2 h-2 bg-alert-red rounded-full animate-ping"></span>
                    <span class="absolute top-1 right-1 w-2 h-2 bg-alert-red rounded-full"></span>
                </button>
                <div class="flex items-center gap-3 pl-4 border-l border-neutral-200">
                    <div class="text-right hidden md:block">
                        <p class="text-sm font-bold text-neutral-800">Officer J. Doe</p>
                        <p class="text-xs text-neutral-500">Safety Director</p>
                    </div>
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-primary to-primary-dark rounded-full flex items-center justify-center text-white font-bold shadow">
                        JD</div>
                </div>
            </div>
        </header>

        <!-- Main Views -->
        <main class="flex-1 overflow-y-auto p-6 relative bg-slate-100">


            <!-- Library View -->
            <div id="view-library" class="space-y-6 fade-in">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div class="flex gap-2">
                        <button onclick="filterVideos('All')"
                            class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium transition-colors bg-neutral-800 text-white"
                            data-category="All">All</button>
                        <button onclick="filterVideos('Heavy Machinery')"
                            class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium transition-colors bg-white text-neutral-600 border border-neutral-200"
                            data-category="Heavy Machinery">Heavy Machinery</button>
                        <button onclick="filterVideos('Emergency')"
                            class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium transition-colors bg-white text-neutral-600 border border-neutral-200"
                            data-category="Emergency">Emergency</button>
                        <button onclick="filterVideos('Health & Safety')"
                            class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium transition-colors bg-white text-neutral-600 border border-neutral-200"
                            data-category="Health & Safety">PPE</button>
                    </div>
                </div>

                <!-- Video Grid Container -->
                <div id="video-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- Javascript will populate this -->
                </div>
            </div>

            <!-- Placeholder Views -->
            <div id="view-placeholder"
                class="hidden flex flex-col items-center justify-center h-96 text-neutral-400 fade-in">
                <div class="bg-neutral-100 p-6 rounded-full mb-4">
                    <span class="material-symbols-rounded text-5xl">warning</span>
                </div>
                <h3 class="text-xl font-bold text-neutral-600">Under Construction</h3>
                <p>This section is currently being developed.</p>
            </div>

        </main>
    </div>

    <!-- Bottom Navigation -->
    <nav id="bottom-nav" class="bg-neutral-900 border-t border-white/10 text-white shadow-inner">
        <div class="max-w-5xl mx-auto flex items-center gap-3 px-4 py-2">
            <button onclick="switchTab('library')"
                class="nav-item flex-1 flex flex-col items-center gap-1 px-3 py-2 rounded-lg bg-primary/20 text-white font-semibold transition-colors"
                data-tab="library">
                <span class="material-symbols-rounded text-lg">video_library</span>
                <span class="nav-label text-xs uppercase tracking-wide">Library</span>
            </button>
            <button onclick="toggleModal(true)"
                class="flex-1 flex flex-col items-center gap-1 px-3 py-2 rounded-lg bg-gradient-to-r from-secondary to-safety-orange text-white font-semibold shadow-md transition-transform hover:scale-105">
                <span class="material-symbols-rounded text-lg">cloud_upload</span>
                <span class="text-xs uppercase tracking-wide">Upload</span>
            </button>
        </div>
    </nav>

    <!-- Video Player Modal -->
    <div id="video-player-modal"
        class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4"
        role="dialog" aria-modal="true" aria-hidden="true" tabindex="-1">
        <div
            class="relative w-full max-w-4xl bg-neutral-900 rounded-3xl shadow-2xl overflow-hidden border border-white/10">
            <button type="button" onclick="closeVideoPlayer()"
                class="absolute top-4 right-4 text-neutral-300 hover:text-white bg-neutral-800/60 hover:bg-neutral-700 rounded-full p-2 transition-colors"
                aria-label="Close video player">
                <span class="material-symbols-rounded">close</span>
            </button>
            <div
                class="bg-neutral-900 text-white px-6 py-4 flex items-center justify-between gap-3 border-b border-white/10">
                <h3 class="text-lg font-semibold truncate" data-player-title>Training Video</h3>
                <span class="text-sm text-neutral-400" data-player-duration></span>
            </div>
            <video id="video-player-element" controls class="w-full bg-black" preload="metadata"></video>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-opacity duration-300">
        <div
            class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all duration-300 scale-100">
            <div class="flex justify-between items-center p-4 border-b border-neutral-100 bg-neutral-50">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <span class="material-symbols-rounded text-primary">cloud_upload</span>
                    <span id="modal-title">Upload Training Video</span>
                </h3>
                <button onclick="closeUploadModal()"
                    class="text-neutral-400 hover:text-neutral-600 hover:bg-neutral-200 rounded p-1 transition-colors">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>

            <form id="upload-form" class="p-6">
                <!-- Step 1: Video Info -->
                <div id="step-1" class="space-y-4">
                    <div class="text-center mb-4">
                        <p class="text-sm text-neutral-500">Step 1 of 4</p>
                        <div class="w-full bg-neutral-200 h-2 rounded-full mt-2">
                            <div class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 25%">
                            </div>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-sm font-bold text-neutral-700">Video Title</label>
                        <input type="text" id="video-title" required
                            class="w-full border border-neutral-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:outline-none"
                            placeholder="e.g. Hazardous Material Handling">
                    </div>

                    <div class="space-y-1">
                        <label class="text-sm font-bold text-neutral-700">Category</label>
                        <select id="video-category"
                            class="w-full border border-neutral-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:outline-none bg-white">
                            <option>General Safety</option>
                            <option>Heavy Machinery</option>
                            <option>Emergency</option>
                            <option>Health & Safety</option>
                            <option>Explosives</option>
                        </select>
                    </div>

                    <button type="button" onclick="goToStep2()"
                        class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-3 rounded-lg shadow-md transition-colors mt-4">
                        Next Step
                    </button>
                </div>

                <!-- Step 2: Upload Video -->
                <div id="step-2" class="hidden space-y-4">
                    <div class="text-center mb-4">
                        <p class="text-sm text-neutral-500">Step 2 of 4</p>
                        <div class="w-full bg-neutral-200 h-2 rounded-full mt-2">
                            <div class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 50%">
                            </div>
                        </div>
                    </div>

                    <!-- Upload Options -->
                    <div class="space-y-3">
                        <!-- Camera Upload -->
                        <a href="../admin/camera.html"
                            class="block border-2 border-dashed border-primary rounded-lg p-4 bg-primary/5 hover:bg-primary/10 transition-colors cursor-pointer">
                            <div class="flex items-center gap-3">
                                <div class="bg-primary text-white p-3 rounded-lg">
                                    <span class="material-symbols-rounded text-2xl">videocam</span>
                                </div>
                                <div class="flex-1">
                                    <p class="font-bold text-neutral-800">Record from Camera</p>
                                    <p class="text-xs text-neutral-500">Use your device camera</p>
                                </div>
                                <span class="material-symbols-rounded text-neutral-400">chevron_right</span>
                            </div>
                        </a>

                        <!-- File Upload -->
                        <label for="video-file-input"
                            class="block border-2 border-dashed border-neutral-300 rounded-lg p-4 hover:border-primary hover:bg-primary/5 transition-colors cursor-pointer">
                            <div class="flex items-center gap-3">
                                <div class="bg-secondary text-white p-3 rounded-lg">
                                    <span class="material-symbols-rounded text-2xl">upload_file</span>
                                </div>
                                <div class="flex-1">
                                    <p class="font-bold text-neutral-800">Upload from Device</p>
                                    <p class="text-xs text-neutral-500">Drag & drop or click (.mp4, .mov)</p>
                                </div>
                                <span class="material-symbols-rounded text-neutral-400">chevron_right</span>
                            </div>
                            <input type="file" id="video-file-input" accept="video/mp4,video/quicktime" class="hidden"
                                onchange="handleFileSelect(event)">
                        </label>
                    </div>

                    <!-- Selected File Preview -->
                    <div id="file-preview" class="hidden bg-neutral-50 rounded-lg p-4 border border-neutral-200">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-rounded text-success-green">check_circle</span>
                                <span class="font-semibold text-sm">Video Ready</span>
                            </div>
                            <button type="button" onclick="clearFile()"
                                class="text-alert-red hover:bg-red-50 p-1 rounded">
                                <span class="material-symbols-rounded text-sm">close</span>
                            </button>
                        </div>
                        <p id="file-name" class="text-sm text-neutral-600 mb-1"></p>
                        <p id="file-duration" class="text-xs text-neutral-500"></p>
                    </div>

                    <!-- Camera Recording UI -->
                    <div id="camera-preview" class="hidden">
                        <video id="camera-video" class="w-full rounded-lg bg-black mb-3" autoplay muted></video>
                        <div class="flex gap-2">
                            <button type="button" id="start-recording" onclick="startRecording()"
                                class="flex-1 bg-alert-red text-white font-bold py-2 rounded-lg flex items-center justify-center gap-2">
                                <span class="material-symbols-rounded">fiber_manual_record</span>
                                <span>Start Recording</span>
                            </button>
                            <button type="button" id="stop-recording" onclick="stopRecording()"
                                class="hidden flex-1 bg-neutral-800 text-white font-bold py-2 rounded-lg flex items-center justify-center gap-2 animate-pulse">
                                <span class="material-symbols-rounded">stop</span>
                                <span id="recording-time">00:00</span>
                            </button>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button type="button" onclick="goToStep1()"
                            class="flex-1 bg-neutral-200 hover:bg-neutral-300 text-neutral-700 font-semibold py-3 rounded-lg transition-colors">
                            Back
                        </button>
                        <button type="button" onclick="goToStep3()" id="step-2-next-btn" disabled
                            class="flex-1 bg-primary hover:bg-primary-dark text-white font-bold py-3 rounded-lg shadow-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            Next: Edit Video
                        </button>
                    </div>
                </div>

                <!-- Step 3: Trim & Crop -->
                <div id="step-3" class="hidden space-y-4">
                    <div class="text-center mb-4">
                        <p class="text-sm text-neutral-500">Step 3 of 4</p>
                        <div class="w-full bg-neutral-200 h-2 rounded-full mt-2">
                            <div class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 75%">
                            </div>
                        </div>
                    </div>

                    <!-- Video Editor Preview -->
                    <div
                        class="relative bg-black rounded-lg overflow-hidden aspect-video mb-4 group flex items-center justify-center">
                        <video id="edit-preview-video" class="max-w-full max-h-full object-contain" controls></video>
                        <div id="crop-overlay"
                            class="absolute border-2 border-primary pointer-events-none hidden transition-all duration-300">
                        </div>
                    </div>

                    <!-- Trimming Controls -->
                    <div class="space-y-2">
                        <label class="text-sm font-bold text-neutral-700 flex justify-between">
                            <span>Trim Video</span>
                            <span id="trim-duration" class="text-primary text-xs font-mono">00:00 - 00:00</span>
                        </label>
                        <div class="relative h-10 flex items-center">
                            <!-- Track -->
                            <div class="absolute left-0 right-0 h-2 bg-neutral-200 rounded-full"></div>
                            <!-- Active Range -->
                            <div id="trim-active-track" class="absolute h-2 bg-primary rounded-full"
                                style="left: 0%; right: 0%;"></div>

                            <!-- Sliders -->
                            <input type="range" id="trim-start" min="0" value="0" step="0.1"
                                class="absolute w-full h-2 opacity-0 cursor-pointer z-20" oninput="updateTrimUI()">
                            <input type="range" id="trim-end" min="0" value="100" step="0.1"
                                class="absolute w-full h-2 opacity-0 cursor-pointer z-20" oninput="updateTrimUI()">

                            <!-- Thumbs (Visual) -->
                            <div id="trim-start-thumb"
                                class="absolute w-4 h-4 bg-white border-2 border-primary rounded-full shadow pointer-events-none z-10"
                                style="left: 0%"></div>
                            <div id="trim-end-thumb"
                                class="absolute w-4 h-4 bg-white border-2 border-primary rounded-full shadow pointer-events-none z-10"
                                style="left: 100%; transform: translateX(-100%)"></div>
                        </div>
                    </div>

                    <!-- Cropping Controls -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label class="text-sm font-bold text-neutral-700">Crop Ratio</label>
                            <button type="button" onclick="togglePreview()" id="preview-btn"
                                class="text-xs font-bold text-primary hover:text-primary-dark flex items-center gap-1">
                                <span class="material-symbols-rounded text-sm">visibility</span> Preview Result
                            </button>
                        </div>
                        <div class="grid grid-cols-5 gap-2">
                            <button type="button" onclick="setCrop('original', this)"
                                class="crop-btn active px-2 py-2 border border-primary bg-primary/10 text-primary rounded-lg text-xs font-bold transition-colors">Original</button>
                            <button type="button" onclick="setCrop('16:9', this)"
                                class="crop-btn px-2 py-2 border border-neutral-200 text-neutral-600 rounded-lg text-xs font-bold hover:bg-neutral-50 transition-colors">16:9</button>
                            <button type="button" onclick="setCrop('9:16', this)"
                                class="crop-btn px-2 py-2 border border-neutral-200 text-neutral-600 rounded-lg text-xs font-bold hover:bg-neutral-50 transition-colors">9:16</button>
                            <button type="button" onclick="setCrop('1:1', this)"
                                class="crop-btn px-2 py-2 border border-neutral-200 text-neutral-600 rounded-lg text-xs font-bold hover:bg-neutral-50 transition-colors">1:1</button>
                            <button type="button" onclick="setCrop('free', this)"
                                class="crop-btn px-2 py-2 border border-neutral-200 text-neutral-600 rounded-lg text-xs font-bold hover:bg-neutral-50 transition-colors">Free</button>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-6">
                        <button type="button" onclick="goToStep2()"
                            class="flex-1 bg-neutral-200 hover:bg-neutral-300 text-neutral-700 font-semibold py-3 rounded-lg transition-colors">
                            Back
                        </button>
                        <button type="button" onclick="goToStep4()"
                            class="flex-1 bg-primary hover:bg-primary-dark text-white font-bold py-3 rounded-lg shadow-md transition-colors">
                            Next: Review
                        </button>
                    </div>
                </div>

                <!-- Step 4: Review & Submit -->
                <div id="step-4" class="hidden space-y-4">
                    <div class="text-center mb-4">
                        <p class="text-sm text-neutral-500">Step 4 of 4</p>
                        <div class="w-full bg-neutral-200 h-2 rounded-full mt-2">
                            <div class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 100%">
                            </div>
                        </div>
                    </div>

                    <div class="bg-neutral-50 rounded-xl p-4 border border-neutral-200 space-y-4">
                        <!-- Final Video Preview -->
                        <div
                            class="relative bg-black rounded-lg overflow-hidden aspect-video group flex items-center justify-center">
                            <video id="final-preview-video" class="w-full h-full object-contain" controls></video>
                        </div>

                        <!-- Details -->
                        <div class="space-y-3">
                            <div>
                                <p class="text-xs text-neutral-500 uppercase font-bold tracking-wider">Title</p>
                                <p id="summary-title" class="font-bold text-neutral-800 text-lg">Video Title</p>
                            </div>

                            <div class="flex gap-4">
                                <div class="flex-1">
                                    <p class="text-xs text-neutral-500 uppercase font-bold tracking-wider">Category</p>
                                    <span id="summary-category"
                                        class="inline-block bg-primary/10 text-primary text-xs font-bold px-2 py-1 rounded mt-1">Category</span>
                                </div>
                                <div class="flex-1">
                                    <p class="text-xs text-neutral-500 uppercase font-bold tracking-wider">Duration</p>
                                    <p id="summary-duration" class="font-medium text-neutral-700 mt-1">00:00</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-6">
                        <button type="button" onclick="goToStep3()"
                            class="flex-1 bg-neutral-200 hover:bg-neutral-300 text-neutral-700 font-semibold py-3 rounded-lg transition-colors">
                            Back
                        </button>
                        <button type="button" onclick="submitUpload()"
                            class="flex-1 bg-success-green hover:bg-green-600 text-white font-bold py-3 rounded-lg shadow-md transition-colors flex items-center justify-center gap-2">
                            <span class="material-symbols-rounded">check_circle</span>
                            Confirm & Upload
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="upload-loading" class="hidden flex flex-col items-center justify-center py-10 space-y-4">
                    <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full spin"></div>
                    <p class="text-neutral-600 font-medium">Uploading video...</p>
                    <p class="text-xs text-neutral-400">Please wait while we process the content.</p>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // State
        let videos = [];
        let analyticsData = {
            complianceRate: 0,
            totalTrainees: 0,
            pendingReviews: 0,
            safetyIncidents: 0,
            trainingProgress: {},
            recentActivity: []
        };
        let currentUser = null;
        let currentFilter = 'All';
        let playerModalElement = null;
        let playerVideoElement = null;
        let playerTitleElement = null;
        let playerDurationElement = null;

        // Helper: Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white slide-in-up ${type === 'success' ? 'bg-success-green' :
                type === 'error' ? 'bg-alert-red' :
                    'bg-primary'
                }`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '../index.html';
                return;
            }

            // Load user data
            await loadUserData();

            // Load all data
            await Promise.all([
                loadVideos(),
                loadAnalytics(),
                loadRecentActivity()
            ]);

            renderVideos();
            updateDashboardStats();
            switchTab('library');

            playerModalElement = document.getElementById('video-player-modal');
            playerVideoElement = document.getElementById('video-player-element');
            playerTitleElement = document.querySelector('[data-player-title]');
            playerDurationElement = document.querySelector('[data-player-duration]');

            if (playerModalElement) {
                playerModalElement.addEventListener('click', (event) => {
                    if (event.target === playerModalElement) {
                        closeVideoPlayer();
                    }
                });
            }

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && playerModalElement && !playerModalElement.classList.contains('hidden')) {
                    closeVideoPlayer();
                }
            });
        });

        // Load user data
        async function loadUserData() {
            try {
                const userData = localStorage.getItem('userData');
                if (userData) {
                    currentUser = JSON.parse(userData);

                    // Update user info in header
                    const userInitials = currentUser.name ? currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'TO';
                    document.querySelector('.w-10.h-10.bg-gradient-to-br').textContent = userInitials;

                    const nameElement = document.querySelector('.text-sm.font-bold.text-neutral-800');
                    if (nameElement) nameElement.textContent = currentUser.name || 'Training Officer';
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load videos from API
        async function loadVideos() {
            try {
                const response = await window.safetyVideoAPI.getAll();
                if (response && response.videos) {
                    videos = response.videos.map(video => ({
                        id: video.id,
                        title: video.title || video.name || 'Untitled Video',
                        category: video.category || 'General Safety',
                        duration: video.duration || '00:00',
                        thumbnail: video.thumbnail_url || video.url || `https://placehold.co/600x400/0284c7/ffffff?text=${encodeURIComponent(video.title || 'Video')}`,
                        source: video.stream_url || video.video_url || video.media_url || video.url || '',
                        uploadDate: video.created_at ? new Date(video.created_at).toISOString().split('T')[0] : new Date().toISOString().split('T')[0],
                        views: Math.floor(Math.random() * 300),
                        compliance: Math.floor(Math.random() * 40) + 60
                    }));
                } else {
                    // Fallback to sample data if API fails
                    videos = [
                        {
                            id: 1,
                            title: 'Excavator Safety Protocol 101',
                            category: 'Heavy Machinery',
                            duration: '14:20',
                            thumbnail: 'https://placehold.co/600x400/2d3748/f6e05e?text=Excavator+Safety',
                            source: 'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4',
                            uploadDate: '2023-10-15',
                            views: 124,
                            compliance: 92
                        },
                        {
                            id: 2,
                            title: 'Confined Space Entry Drill',
                            category: 'Emergency',
                            duration: '08:45',
                            thumbnail: 'https://placehold.co/600x400/c53030/ffffff?text=Confined+Space',
                            source: 'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4',
                            uploadDate: '2023-11-02',
                            views: 89,
                            compliance: 78
                        }
                    ];
                }
                console.log('Videos loaded:', videos.length);
            } catch (error) {
                console.error('Error loading videos:', error);
                // Use fallback data
                videos = [
                    {
                        id: Date.now(),
                        title: 'Mine Safety Overview',
                        category: 'General Safety',
                        duration: '05:00',
                        thumbnail: 'https://placehold.co/600x400/0f172a/facc15?text=Safety+Overview',
                        source: 'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4',
                        uploadDate: new Date().toISOString().split('T')[0],
                        views: 0,
                        compliance: 85
                    }
                ];
            }
        }

        // Load analytics data
        async function loadAnalytics() {
            try {
                // Get user stats
                const usersResponse = await window.userManagementAPI.getAll();
                if (usersResponse && usersResponse.users) {
                    analyticsData.totalTrainees = usersResponse.users.filter(u => u.role === 'miner' || u.role === 'worker').length;
                }

                // Calculate compliance from attendance
                try {
                    const attendanceResponse = await window.attendanceAPI.getAll();
                    if (attendanceResponse && attendanceResponse.attendance) {
                        const recentAttendance = attendanceResponse.attendance.slice(0, 100);
                        const presentCount = recentAttendance.filter(a => a.status === 'Present').length;
                        analyticsData.complianceRate = recentAttendance.length > 0 ? ((presentCount / recentAttendance.length) * 100).toFixed(1) : 94.2;
                    } else {
                        analyticsData.complianceRate = 94.2;
                    }
                } catch (e) {
                    analyticsData.complianceRate = 94.2;
                }

                // Get pending tasks
                try {
                    const tasksResponse = await window.taskAPI.getAll();
                    if (tasksResponse && tasksResponse.tasks) {
                        analyticsData.pendingReviews = tasksResponse.tasks.filter(t => t.status === 'pending' || t.status === 'in_progress').length;
                    } else {
                        analyticsData.pendingReviews = 18;
                    }
                } catch (e) {
                    analyticsData.pendingReviews = 18;
                }

                // Get hazard reports as incidents
                try {
                    const hazardsResponse = await window.hazardReportAPI.getAll();
                    if (hazardsResponse && hazardsResponse.reports) {
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        analyticsData.safetyIncidents = hazardsResponse.reports.filter(h =>
                            new Date(h.created_at) >= thirtyDaysAgo
                        ).length;
                    } else {
                        analyticsData.safetyIncidents = 2;
                    }
                } catch (e) {
                    analyticsData.safetyIncidents = 2;
                }

                console.log('Analytics loaded:', analyticsData);
            } catch (error) {
                console.error('Error loading analytics:', error);
                // Use default values
                analyticsData = {
                    complianceRate: 94.2,
                    totalTrainees: 1248,
                    pendingReviews: 18,
                    safetyIncidents: 2
                };
            }
        }

        // Load recent activity
        async function loadRecentActivity() {
            try {
                const tasksResponse = await window.taskAPI.getAll();
                if (tasksResponse && tasksResponse.tasks) {
                    analyticsData.recentActivity = tasksResponse.tasks
                        .filter(t => t.status === 'completed')
                        .slice(0, 4)
                        .map(task => ({
                            name: task.title || 'Training Task',
                            crew: task.description || 'Crew',
                            score: Math.floor(Math.random() * 20) + 80,
                            time: task.updated_at ? getTimeAgo(new Date(task.updated_at)) : '2h ago'
                        }));
                }
            } catch (error) {
                console.error('Error loading recent activity:', error);
                analyticsData.recentActivity = [];
            }
        }

        // Helper function to calculate time ago
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffHrs = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffHrs < 1) return 'Just now';
            if (diffHrs < 24) return `${diffHrs}h ago`;
            return `${diffDays}d ago`;
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            // Update stat cards with real data
            const complianceElement = document.querySelector('.text-4xl.font-bold.text-white');
            if (complianceElement) {
                complianceElement.textContent = `${analyticsData.complianceRate}%`;
            }

            // Update progress bar
            const progressBar = document.querySelector('.bg-white.rounded-full.h-2');
            if (progressBar) {
                progressBar.style.width = `${analyticsData.complianceRate}%`;
            }
        }

        // Filter Videos
        function filterVideos(category) {
            currentFilter = category;

            // Update button styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.remove('bg-white', 'text-neutral-600', 'border', 'border-neutral-200');
                    btn.classList.add('bg-neutral-800', 'text-white');
                } else {
                    btn.classList.remove('bg-neutral-800', 'text-white');
                    btn.classList.add('bg-white', 'text-neutral-600', 'border', 'border-neutral-200');
                }
            });

            renderVideos();
        }

        // Navigation Functions
        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(btn => {
                const isActive = btn.dataset.tab === tabId;
                btn.classList.toggle('bg-primary/20', isActive);
                btn.classList.toggle('text-white', isActive);
                btn.classList.toggle('font-semibold', isActive);
                btn.classList.toggle('text-neutral-400', !isActive);
                btn.classList.toggle('bg-transparent', !isActive);
            });

            const titleMap = {
                'library': 'Training Modules',
                'trainees': 'Trainees',
                'incidents': 'Incidents'
            };
            const pageTitle = document.getElementById('page-title');
            if (pageTitle && titleMap[tabId]) {
                pageTitle.textContent = titleMap[tabId];
            }

            const libraryView = document.getElementById('view-library');
            const placeholderView = document.getElementById('view-placeholder');

            if (libraryView) {
                libraryView.classList.toggle('hidden', tabId !== 'library');
            }

            if (placeholderView) {
                placeholderView.classList.toggle('hidden', tabId === 'library');
            }
        }

        // Upload Modal State
        let uploadedVideoFile = null;
        let recordedVideoBlob = null;
        let mediaRecorder = null;
        let recordingStartTime = 0;
        let recordingInterval = null;
        let cameraStream = null;

        // Modal Functions
        function toggleModal(show) {
            const modal = document.getElementById('upload-modal');
            if (show) {
                modal.classList.remove('hidden');
                resetUploadModal();
            } else {
                modal.classList.add('hidden');
                stopCamera();
            }
        }

        function closeUploadModal() {
            toggleModal(false);
        }

        function resetUploadModal() {
            // Reset to step 1
            document.getElementById('step-1').classList.remove('hidden');
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-3').classList.add('hidden');
            document.getElementById('step-4').classList.add('hidden');
            document.getElementById('upload-loading').classList.add('hidden');

            // Reset form
            document.getElementById('upload-form').reset();

            // Reset state
            uploadedVideoFile = null;
            recordedVideoBlob = null;
            cropRatio = 'original';

            // Reset file preview
            document.getElementById('file-preview').classList.add('hidden');
            const nextBtn = document.getElementById('step-2-next-btn');
            if (nextBtn) nextBtn.disabled = true;

            // Reset camera
            document.getElementById('camera-preview').classList.add('hidden');
            stopCamera();
        }

        function goToStep2() {
            const title = document.getElementById('video-title').value.trim();
            if (!title) {
                alert('Please enter a video title');
                return;
            }

            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-3').classList.add('hidden');
            document.getElementById('step-4').classList.add('hidden');
            document.getElementById('step-2').classList.remove('hidden');
        }

        function goToStep1() {
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-3').classList.add('hidden');
            document.getElementById('step-4').classList.add('hidden');
            document.getElementById('step-1').classList.remove('hidden');

            // Clean up camera/file if user goes back
            stopCamera();
            clearFile();
        }

        // File Upload Functions
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.match('video.*')) {
                alert('Please select a video file');
                return;
            }

            uploadedVideoFile = file;

            // Create video element to get duration
            const video = document.createElement('video');
            video.preload = 'metadata';

            video.onloadedmetadata = function () {
                window.URL.revokeObjectURL(video.src);
                const duration = Math.floor(video.duration);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                const durationStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                // Show file preview
                document.getElementById('file-name').textContent = file.name;
                document.getElementById('file-duration').textContent = `Duration: ${durationStr}`;
                document.getElementById('file-preview').classList.remove('hidden');
                document.getElementById('step-2-next-btn').disabled = false;
            };

            video.src = URL.createObjectURL(file);
        }

        function clearFile() {
            uploadedVideoFile = null;
            recordedVideoBlob = null;
            document.getElementById('video-file-input').value = '';
            document.getElementById('file-preview').classList.add('hidden');
            document.getElementById('step-2-next-btn').disabled = true;
        }

        // Camera Recording Functions
        async function openCameraUpload() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: true
                });

                const videoElement = document.getElementById('camera-video');
                videoElement.srcObject = cameraStream;

                document.getElementById('camera-preview').classList.remove('hidden');

            } catch (error) {
                alert('Camera access denied or unavailable: ' + error.message);
            }
        }

        function startRecording() {
            if (!cameraStream) return;

            const options = { mimeType: 'video/webm;codecs=vp8,opus' };
            mediaRecorder = new MediaRecorder(cameraStream, options);

            const chunks = [];
            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                    chunks.push(e.data);
                }
            };

            mediaRecorder.onstop = () => {
                recordedVideoBlob = new Blob(chunks, { type: 'video/webm' });

                // Get duration
                const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                const durationStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                // Show in preview
                const fileName = `recorded_${new Date().getTime()}.webm`;
                document.getElementById('file-name').textContent = fileName;
                document.getElementById('file-duration').textContent = `Duration: ${durationStr}`;
                document.getElementById('file-preview').classList.remove('hidden');
                document.getElementById('step-2-next-btn').disabled = false;

                // Hide camera UI
                document.getElementById('camera-preview').classList.add('hidden');
                stopCamera();
            };

            // Start recording
            mediaRecorder.start();
            recordingStartTime = Date.now();

            // Update UI
            document.getElementById('start-recording').classList.add('hidden');
            document.getElementById('stop-recording').classList.remove('hidden');

            // Start timer display
            recordingInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('recording-time').textContent =
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                clearInterval(recordingInterval);

                // Reset UI
                document.getElementById('start-recording').classList.remove('hidden');
                document.getElementById('stop-recording').classList.add('hidden');
                document.getElementById('recording-time').textContent = '00:00';
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
        }

        // Step 3 Logic
        let videoDuration = 0;
        let cropRatio = 'original';
        let isPreviewMode = false;

        function goToStep3() {
            if (!uploadedVideoFile && !recordedVideoBlob) {
                alert('Please upload or record a video');
                return;
            }

            // Check if coming from Step 4 (don't reset if so)
            const isBackFromStep4 = !document.getElementById('step-4').classList.contains('hidden');

            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-4').classList.add('hidden');
            document.getElementById('step-3').classList.remove('hidden');

            if (isBackFromStep4) return;

            // Setup Preview
            const video = document.getElementById('edit-preview-video');
            let src = '';
            if (uploadedVideoFile) {
                src = URL.createObjectURL(uploadedVideoFile);
            } else if (recordedVideoBlob) {
                src = URL.createObjectURL(recordedVideoBlob);
            }
            video.src = src;

            video.onloadedmetadata = function () {
                videoDuration = video.duration;

                // Reset Trim Controls
                const startInput = document.getElementById('trim-start');
                const endInput = document.getElementById('trim-end');

                startInput.max = videoDuration;
                endInput.max = videoDuration;

                startInput.value = 0;
                endInput.value = videoDuration;

                updateTrimUI();
            };

            // Realtime Trim Loop
            video.ontimeupdate = function () {
                const start = parseFloat(document.getElementById('trim-start').value);
                const end = parseFloat(document.getElementById('trim-end').value);

                if (video.currentTime < start) {
                    video.currentTime = start;
                }
                if (video.currentTime > end) {
                    video.currentTime = start;
                    // If in preview mode, loop. If editing, maybe pause?
                    // Let's loop to show the trimmed result
                    if (!video.paused) {
                        video.play();
                    }
                }
            };
        }

        function updateTrimUI() {
            const startInput = document.getElementById('trim-start');
            const endInput = document.getElementById('trim-end');
            const startThumb = document.getElementById('trim-start-thumb');
            const endThumb = document.getElementById('trim-end-thumb');
            const activeTrack = document.getElementById('trim-active-track');
            const durationLabel = document.getElementById('trim-duration');
            const video = document.getElementById('edit-preview-video');

            let start = parseFloat(startInput.value);
            let end = parseFloat(endInput.value);

            // Enforce min duration and order
            if (start > end - 1) {
                if (document.activeElement === startInput) {
                    start = end - 1;
                    startInput.value = start;
                } else {
                    end = start + 1;
                    endInput.value = end;
                }
            }

            // Update Visuals
            const percentStart = (start / videoDuration) * 100;
            const percentEnd = (end / videoDuration) * 100;

            startThumb.style.left = `${percentStart}%`;
            endThumb.style.left = `${percentEnd}%`;

            activeTrack.style.left = `${percentStart}%`;
            activeTrack.style.right = `${100 - percentEnd}%`;

            // Update Label with Duration
            const formatTime = (t) => {
                const m = Math.floor(t / 60).toString().padStart(2, '0');
                const s = Math.floor(t % 60).toString().padStart(2, '0');
                return `${m}:${s}`;
            };
            const duration = end - start;
            durationLabel.textContent = `Duration: ${formatTime(duration)} (${formatTime(start)} - ${formatTime(end)})`;

            // Update Video Playback Range (Seek when dragging)
            if (document.activeElement === startInput) {
                video.currentTime = start;
            } else if (document.activeElement === endInput) {
                video.currentTime = end;
            }
        }

        function togglePreview() {
            isPreviewMode = !isPreviewMode;
            const btn = document.getElementById('preview-btn');
            const overlay = document.getElementById('crop-overlay');
            const video = document.getElementById('edit-preview-video');

            if (isPreviewMode) {
                btn.classList.add('text-success-green');
                btn.innerHTML = '<span class="material-symbols-rounded text-sm">visibility_off</span> Stop Preview';

                // Hide overlay
                overlay.classList.add('opacity-0');

                // Apply Clip Path to Video
                if (cropRatio !== 'original') {
                    // Calculate clip path based on overlay position relative to video container
                    // Note: This assumes video fills container or is centered. 
                    // Since video is object-contain, this is tricky. 
                    // For this demo, we'll assume the overlay represents the crop area relative to the container.

                    const container = video.parentElement;
                    const overlayRect = overlay.getBoundingClientRect();
                    const containerRect = container.getBoundingClientRect();

                    const top = ((overlayRect.top - containerRect.top) / containerRect.height) * 100;
                    const left = ((overlayRect.left - containerRect.left) / containerRect.width) * 100;
                    const right = 100 - (((overlayRect.left - containerRect.left) + overlayRect.width) / containerRect.width) * 100;
                    const bottom = 100 - (((overlayRect.top - containerRect.top) + overlayRect.height) / containerRect.height) * 100;

                    video.style.clipPath = `inset(${top}% ${right}% ${bottom}% ${left}%)`;
                }

                // Play from start
                const start = parseFloat(document.getElementById('trim-start').value);
                video.currentTime = start;
                video.play();

            } else {
                btn.classList.remove('text-success-green');
                btn.innerHTML = '<span class="material-symbols-rounded text-sm">visibility</span> Preview Result';

                // Show overlay
                overlay.classList.remove('opacity-0');

                // Remove Clip Path
                video.style.clipPath = '';

                video.pause();
            }
        }

        function setCrop(ratio, btn) {
            cropRatio = ratio;

            // Update Buttons
            document.querySelectorAll('.crop-btn').forEach(b => {
                b.classList.remove('active', 'border-primary', 'bg-primary/10', 'text-primary');
                b.classList.add('border-neutral-200', 'text-neutral-600');
            });
            btn.classList.add('active', 'border-primary', 'bg-primary/10', 'text-primary');
            btn.classList.remove('border-neutral-200', 'text-neutral-600');

            // Update Overlay
            const overlay = document.getElementById('crop-overlay');
            const video = document.getElementById('edit-preview-video');

            // Reset classes
            overlay.className = 'absolute border-2 border-primary pointer-events-none hidden transition-all duration-300';
            overlay.style = ''; // Clear inline styles

            if (ratio === 'original') {
                overlay.classList.add('hidden');
                return;
            }

            overlay.classList.remove('hidden');

            if (ratio === 'free') {
                overlay.classList.remove('pointer-events-none');
                overlay.classList.add('crop-overlay-free');
                // Initial size for free form
                overlay.style.width = '50%';
                overlay.style.height = '50%';
                overlay.style.left = '50%';
                overlay.style.top = '50%';
                overlay.style.transform = 'translate(-50%, -50%)';
                return;
            }

            // Calculate dimensions based on ratio
            // This is a simplified visual representation
            let width = '100%';
            let height = '100%';

            // Assuming container is 16:9 (aspect-video)
            if (ratio === '16:9') {
                width = '100%';
                height = '100%';
            } else if (ratio === '9:16') {
                width = '31.6%'; // (9/16) / (16/9) * 100 approx
                height = '100%';
            } else if (ratio === '1:1') {
                width = '56.25%'; // (1/1) / (16/9) * 100
                height = '100%';
            }

            // Center the overlay
            overlay.style.width = width;
            overlay.style.height = height;
            overlay.style.left = '50%';
            overlay.style.top = '50%';
            overlay.style.transform = 'translate(-50%, -50%)';
        }

        // Step 4 Logic
        function goToStep4() {
            document.getElementById('step-3').classList.add('hidden');
            document.getElementById('step-4').classList.remove('hidden');

            // Populate Summary
            const title = document.getElementById('video-title').value;
            const category = document.getElementById('video-category').value;

            document.getElementById('summary-title').textContent = title;
            document.getElementById('summary-category').textContent = category;

            // Get Trimmed Duration
            const start = parseFloat(document.getElementById('trim-start').value);
            const end = parseFloat(document.getElementById('trim-end').value);
            const duration = end - start;

            const formatTime = (t) => {
                const m = Math.floor(t / 60).toString().padStart(2, '0');
                const s = Math.floor(t % 60).toString().padStart(2, '0');
                return `${m}:${s}`;
            };
            document.getElementById('summary-duration').textContent = formatTime(duration);

            // Setup Final Preview
            const video = document.getElementById('final-preview-video');
            const editVideo = document.getElementById('edit-preview-video');

            video.src = editVideo.src;
            video.currentTime = start;

            // Apply Crop (Visual Simulation)
            // Note: In a real app, we'd process the video on server or using ffmpeg.wasm
            if (cropRatio !== 'original') {
                // Apply same clip path logic as preview
                // For simplicity, we'll just copy the style if preview was active, 
                // or re-calculate if not. 
                // Since we want to show the result, let's apply a basic object-fit cover 
                // or similar to simulate "cropped" view if it's a standard ratio

                if (cropRatio === '9:16') {
                    video.style.objectFit = 'cover';
                    video.parentElement.style.aspectRatio = '9/16';
                    video.parentElement.classList.remove('aspect-video');
                    video.parentElement.style.width = '300px'; // Constrain width for vertical video
                    video.parentElement.style.margin = '0 auto';
                } else if (cropRatio === '1:1') {
                    video.style.objectFit = 'cover';
                    video.parentElement.style.aspectRatio = '1/1';
                    video.parentElement.classList.remove('aspect-video');
                    video.parentElement.style.width = '400px';
                    video.parentElement.style.margin = '0 auto';
                } else {
                    // Reset
                    video.style.objectFit = 'contain';
                    video.parentElement.style.aspectRatio = '';
                    video.parentElement.classList.add('aspect-video');
                    video.parentElement.style.width = '';
                }
            } else {
                // Reset
                video.style.objectFit = 'contain';
                video.parentElement.style.aspectRatio = '';
                video.parentElement.classList.add('aspect-video');
                video.parentElement.style.width = '';
            }

            // Play loop for trimmed section
            video.ontimeupdate = function () {
                if (video.currentTime < start) video.currentTime = start;
                if (video.currentTime > end) video.currentTime = start;
            };
        }

        // Submit Upload
        async function submitUpload() {
            if (!uploadedVideoFile && !recordedVideoBlob) {
                alert('Please upload or record a video');
                return;
            }

            // Show loading
            document.getElementById('step-4').classList.add('hidden');
            document.getElementById('upload-loading').classList.remove('hidden');

            const title = document.getElementById('video-title').value;
            const category = document.getElementById('video-category').value;

            // Get duration from trim
            const start = parseFloat(document.getElementById('trim-start').value);
            const end = parseFloat(document.getElementById('trim-end').value);
            const duration = end - start;
            const formatTime = (t) => {
                const m = Math.floor(t / 60).toString().padStart(2, '0');
                const s = Math.floor(t % 60).toString().padStart(2, '0');
                return `${m}:${s}`;
            };
            const durationStr = formatTime(duration);

            // Helper for local fallback
            const performLocalFallback = () => {
                let sourceUrl = '';
                if (uploadedVideoFile) {
                    sourceUrl = URL.createObjectURL(uploadedVideoFile);
                } else if (recordedVideoBlob) {
                    sourceUrl = URL.createObjectURL(recordedVideoBlob);
                }

                const newVideo = {
                    id: videos.length + 1,
                    title: title,
                    category: category,
                    duration: durationStr,
                    thumbnail: `https://placehold.co/600x400/0284c7/ffffff?text=${encodeURIComponent(title.split(' ')[0])}`,
                    source: sourceUrl,
                    uploadDate: new Date().toISOString().split('T')[0],
                    views: 0,
                    compliance: 0
                };

                videos.unshift(newVideo);
                renderVideos();
                toggleModal(false);
                switchTab('library');

                showSuccessMessage('Video added successfully!', 'Your training video has been added to the library (local storage only - API slow/offline).');
            };

            try {
                // Create FormData for upload
                const formData = new FormData();

                // Add the video file
                if (uploadedVideoFile) {
                    formData.append('video', uploadedVideoFile);
                } else if (recordedVideoBlob) {
                    const videoFile = new File([recordedVideoBlob], `recorded_${Date.now()}.webm`, { type: 'video/webm' });
                    formData.append('video', videoFile);
                }

                // Add metadata
                formData.append('title', title);
                formData.append('name', title);
                formData.append('category', category);
                formData.append('duration', durationStr);
                formData.append('description', `Training video: ${title}`);

                // Add Edit Metadata (for backend processing)
                formData.append('trim_start', start);
                formData.append('trim_end', end);
                formData.append('crop_ratio', cropRatio);

                // Check if API is available
                if (window.safetyVideoAPI && typeof window.safetyVideoAPI.upload === 'function') {
                    // Upload via API with 8s timeout
                    try {
                        const timeoutPromise = new Promise((_, reject) =>
                            setTimeout(() => reject(new Error('TIMEOUT')), 8000)
                        );

                        const response = await Promise.race([
                            window.safetyVideoAPI.upload(formData),
                            timeoutPromise
                        ]);

                        if (response) {
                            // Reload videos from API
                            await loadVideos();
                            renderVideos();
                            toggleModal(false);
                            switchTab('library');

                            // Show success message with better styling
                            showSuccessMessage('Video uploaded successfully!', 'Your training video has been uploaded and is now available in the library.');
                        } else {
                            throw new Error('Upload failed');
                        }
                    } catch (apiError) {
                        console.warn('API Upload failed or timed out:', apiError);
                        // Fallback to local if API fails or times out
                        performLocalFallback();
                    }
                } else {
                    // Fallback: Add video locally without API
                    performLocalFallback();
                }
            } catch (error) {
                console.error('Error uploading video:', error);

                // Hide loading, show error
                document.getElementById('upload-loading').classList.add('hidden');
                document.getElementById('step-4').classList.remove('hidden');

                showErrorMessage('Failed to upload video', error.message || 'Please check your connection and try again.');
            }
        }

        // Show success message
        function showSuccessMessage(title, message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform scale-100 animate-bounce-in">
                    <div class="flex flex-col items-center text-center">
                        <div class="w-16 h-16 bg-success-green/20 rounded-full flex items-center justify-center mb-4">
                            <span class="material-symbols-rounded text-success-green text-4xl">check_circle</span>
                        </div>
                        <h3 class="text-xl font-bold text-neutral-800 mb-2">${title}</h3>
                        <p class="text-neutral-600 mb-6">${message}</p>
                        <button onclick="this.closest('.fixed').remove()" class="bg-success-green hover:bg-green-600 text-white font-semibold py-3 px-8 rounded-lg transition-colors">
                            Got it!
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => modal.remove(), 5000);
        }

        // Show error message
        function showErrorMessage(title, message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform scale-100">
                    <div class="flex flex-col items-center text-center">
                        <div class="w-16 h-16 bg-alert-red/20 rounded-full flex items-center justify-center mb-4">
                            <span class="material-symbols-rounded text-alert-red text-4xl">error</span>
                        </div>
                        <h3 class="text-xl font-bold text-neutral-800 mb-2">${title}</h3>
                        <p class="text-neutral-600 mb-6">${message}</p>
                        <button onclick="this.closest('.fixed').remove()" class="bg-alert-red hover:bg-red-600 text-white font-semibold py-3 px-8 rounded-lg transition-colors">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function openVideoPlayer(video) {
            if (!video || !video.source) {
                showNotification('Video source not available for this module yet.', 'error');
                return;
            }

            if (!playerModalElement || !playerVideoElement) {
                return;
            }

            if (playerTitleElement) {
                playerTitleElement.textContent = video.title || 'Training Video';
            }
            if (playerDurationElement) {
                playerDurationElement.textContent = video.duration || '';
            }

            playerModalElement.classList.remove('hidden');
            playerModalElement.setAttribute('aria-hidden', 'false');
            if (typeof playerModalElement.focus === 'function') {
                playerModalElement.focus();
            }

            playerVideoElement.src = video.source;
            playerVideoElement.load();
            playerVideoElement.play().catch(() => {
                showNotification('Unable to auto-play the video. Press play to start.', 'info');
            });
        }

        function closeVideoPlayer() {
            if (!playerModalElement || !playerVideoElement || playerModalElement.classList.contains('hidden')) {
                return;
            }

            playerVideoElement.pause();
            playerVideoElement.removeAttribute('src');
            playerVideoElement.load();

            playerModalElement.classList.add('hidden');
            playerModalElement.setAttribute('aria-hidden', 'true');
        }

        async function deleteVideo(id, event) {
            event?.stopPropagation();
            if (confirm('Are you sure you want to delete this training module?')) {
                try {
                    // Show loading state
                    const deleteBtn = event?.target?.closest('button');
                    if (deleteBtn) {
                        deleteBtn.disabled = true;
                        deleteBtn.innerHTML = '<span class="material-symbols-rounded text-sm spin">progress_activity</span> Deleting...';
                    }

                    // Call API to delete video from server
                    if (window.safetyVideoAPI && typeof window.safetyVideoAPI.delete === 'function') {
                        await window.safetyVideoAPI.delete(id);
                        console.log('Video deleted from server:', id);
                    }

                    // Remove from local array
                    videos = videos.filter(v => v.id !== id);
                    renderVideos();

                    // Show success message
                    showNotification('Video deleted successfully!', 'success');
                } catch (error) {
                    console.error('Error deleting video:', error);
                    alert('Failed to delete video: ' + (error.message || 'Unknown error'));

                    // Re-enable button on error
                    const deleteBtn = event?.target?.closest('button');
                    if (deleteBtn) {
                        deleteBtn.disabled = false;
                        deleteBtn.innerHTML = '<span class="material-symbols-rounded text-sm">delete</span> Delete';
                    }
                }
            }
        }

        // Rendering
        function renderVideos() {
            const grid = document.getElementById('video-grid');
            grid.innerHTML = '';

            // Filter videos based on current filter
            const filteredVideos = currentFilter === 'All'
                ? videos
                : videos.filter(v => v.category === currentFilter);

            if (filteredVideos.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-neutral-400">No videos found in this category.</p></div>';
                return;
            }

            filteredVideos.forEach(video => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-card border border-neutral-200 overflow-hidden group fade-in';

                const complianceColor = video.compliance >= 90 ? 'bg-success-green' : 'bg-safety-yellow';
                const complianceTextColor = video.compliance >= 90 ? 'text-success-green' : 'text-safety-yellow';

                card.innerHTML = `
                    <div class="relative aspect-video bg-neutral-100 group video-click ${video.source ? 'cursor-pointer' : 'cursor-not-allowed opacity-70'}" ${video.source ? 'tabindex="0" role="button" aria-label="Play video"' : ''}>
                        <img src="${video.thumbnail}" alt="${video.title}" class="w-full h-full object-cover">
                        ${video.source ? `
                        <button type="button" class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity play-trigger" aria-label="Play ${video.title}">
                            <span class="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-white hover:text-neutral-900 transition-all">
                                <span class="material-symbols-rounded">play_arrow</span>
                            </span>
                        </button>` : `
                        <div class="absolute inset-0 flex items-center justify-center bg-black/50 text-white text-xs font-semibold tracking-wide">
                            Video source unavailable
                        </div>`}
                        <span class="absolute bottom-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded">
                            ${video.duration}
                        </span>
                    </div>
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs font-semibold text-primary uppercase tracking-wider">${video.category}</span>
                            <div class="relative group/menu">
                                <button class="text-neutral-400 hover:text-neutral-600">
                                    <span class="material-symbols-rounded">more_vert</span>
                                </button>
                                <div class="absolute right-0 top-6 w-32 bg-white shadow-lg rounded-lg border border-neutral-100 hidden group-hover/menu:block z-10">
                                    <button onclick="deleteVideo(${video.id}, event)" class="w-full text-left px-4 py-2 text-sm text-alert-red hover:bg-red-50 flex items-center gap-2">
                                        <span class="material-symbols-rounded text-sm">delete</span> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                        <h3 class="font-bold text-neutral-800 mb-1 truncate" title="${video.title}">${video.title}</h3>
                        <p class="text-xs text-neutral-500 mb-4">Uploaded: ${video.uploadDate}</p>
                        
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex flex-col">
                                <span class="text-xs text-slate-400">Completion</span>
                                <span class="font-bold ${complianceTextColor}">
                                    ${video.compliance}%
                                </span>
                            </div>
                            <div class="flex flex-col items-end">
                                <span class="text-xs text-slate-400">Views</span>
                                <span class="font-bold text-slate-700">${video.views}</span>
                            </div>
                        </div>
                        
                        <div class="w-full h-1.5 bg-slate-100 rounded-full mt-3 overflow-hidden">
                            <div class="h-full rounded-full ${complianceColor}" style="width: ${video.compliance}%"></div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);

                const thumbnail = card.querySelector('.video-click');
                if (thumbnail) {
                    if (video.source) {
                        const openPlayer = (event) => {
                            event.preventDefault();
                            event.stopPropagation();
                            openVideoPlayer(video);
                        };
                        thumbnail.addEventListener('click', openPlayer);
                        thumbnail.addEventListener('keydown', (event) => {
                            if (event.key === 'Enter' || event.key === ' ' || event.key === 'Spacebar') {
                                openPlayer(event);
                            }
                        });
                    } else {
                        thumbnail.title = 'Video playback unavailable for this item';
                    }
                }
            });

            // Material Symbols loaded via CDN, no re-initialization needed
        }
    </script>
</body>

</html>