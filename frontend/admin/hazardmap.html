<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MineSafe - Hazard Map</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,0..200"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script id="tailwind-config">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#0284c7",
                        "alert-red": "#ef4444",
                        "warning-yellow": "#facc15",
                        "success-green": "#22c55e",
                        "neutral-900": "#0f172a"
                    },
                    fontFamily: {
                        "sans": ["Inter", "sans-serif"],
                        "orbitron": ["Orbitron", "sans-serif"]
                    },
                },
            },
        };
    </script>
    <style>
        .material-symbols-rounded {
            font-variation-settings: "FILL" 1, "wght" 400, "GRAD" 0, "opsz" 24;
        }

        /* Map Container Height */
        #map {
            height: calc(100vh - 64px);
            width: 100%;
            z-index: 1;
        }

        /* Custom Marker Pulse */
        @keyframes pulse-ring {
            0% {
                transform: scale(0.33);
            }

            80%,
            100% {
                opacity: 0;
            }
        }

        .marker-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
            background-color: currentColor;
            opacity: 0.6;
        }
    </style>
</head>

<body class="bg-neutral-100 font-sans text-neutral-800 h-screen overflow-hidden flex flex-col">

    <div
        class="h-16 shrink-0 bg-gradient-to-r from-[#020617] via-[#0f172a] to-[#000000] px-4 flex items-center justify-between shadow-lg z-20 relative">
        <div class="flex items-center gap-3">
            <a href="admin-home.html" class="text-white hover:text-primary-light transition">
                <span class="material-symbols-rounded text-2xl">arrow_back</span>
            </a>
            <h1 class="text-xl font-[Orbitron] tracking-widest text-white">Hazard Map</h1>
        </div>
        <div class="flex items-center gap-2">
            <button id="myLocationBtn" class="bg-white/10 text-white p-2 rounded-full hover:bg-white/20 transition">
                <span class="material-symbols-rounded text-xl">my_location</span>
            </button>
            <button onclick="window.location.reload()"
                class="bg-white/10 text-white p-2 rounded-full hover:bg-white/20 transition">
                <span class="material-symbols-rounded text-xl">refresh</span>
            </button>
        </div>
    </div>

    <div id="map" class="bg-neutral-200 relative">
        <div
            class="absolute bottom-6 left-4 z-[500] bg-white/90 backdrop-blur-sm p-3 rounded-xl shadow-lg border border-neutral-200">
            <h4 class="text-xs font-bold text-neutral-500 mb-2 uppercase">Severity Level</h4>
            <div class="space-y-2 text-xs font-medium">
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-red-500 shadow-sm"></span> High / Critical
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-orange-500 shadow-sm"></span> Medium
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-yellow-500 shadow-sm"></span> Low
                </div>
            </div>
        </div>

        <div id="mapLoader" class="absolute inset-0 z-[600] bg-neutral-100 flex flex-col items-center justify-center">
            <div class="w-10 h-10 border-4 border-primary border-t-transparent rounded-full animate-spin mb-3"></div>
            <p class="text-sm font-medium text-neutral-500">Loading Hazard Data...</p>
        </div>
    </div>

    <script src="../api.client.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- 1. AUTH CHECK ---
            const token = localStorage.getItem("token");
            if (!token) { window.location.href = "../index.html"; return; }

            // --- 2. MAP INIT ---
            // Default center (India), zoom level 5
            const map = L.map('map').setView([20.5937, 78.9629], 5);

            // Add Tile Layer (OpenStreetMap - Free)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);

            const loader = document.getElementById('mapLoader');
            let markers = [];

            // --- 3. HELPER FUNCTIONS ---

            // Parse location string "lat, long" OR object { coordinates: [long, lat] }
            const parseCoordinates = (locData) => {
                try {
                    if (!locData) return null;

                    // Case A: String "13.04, 80.12"
                    if (typeof locData === 'string') {
                        const parts = locData.split(',').map(s => parseFloat(s.trim()));
                        if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                            return parts; // [Lat, Long]
                        }
                    }

                    // Case B: GeoJSON Object { type: "Point", coordinates: [long, lat] }
                    // Note: GeoJSON stores as [Longitude, Latitude], Leaflet needs [Latitude, Longitude]
                    if (typeof locData === 'object' && locData.coordinates) {
                        return [locData.coordinates[1], locData.coordinates[0]];
                    }

                    return null;
                } catch (e) {
                    console.error("Location parse error:", e);
                    return null;
                }
            };

            // Get Color based on Severity Name (assuming severity_id is populated)
            const getSeverityColor = (severity) => {
                const name = (severity?.name || '').toLowerCase();
                if (name.includes('critical') || name.includes('high')) return 'bg-red-500 text-red-500';
                if (name.includes('medium')) return 'bg-orange-500 text-orange-500';
                return 'bg-yellow-500 text-yellow-500';
            };

            // Create Custom Leaflet Icon using HTML/Tailwind
            const createCustomIcon = (severity) => {
                const colorClass = getSeverityColor(severity);

                return L.divIcon({
                    className: 'custom-div-icon',
                    html: `
                        <div class="relative w-8 h-8 flex items-center justify-center">
                            <div class="marker-pulse ${colorClass}"></div>
                            <div class="relative w-6 h-6 bg-white rounded-full flex items-center justify-center shadow-md border-2 border-white">
                                <span class="material-symbols-rounded text-base font-bold ${colorClass.split(' ')[1]}">warning</span>
                            </div>
                        </div>
                    `,
                    iconSize: [32, 32],
                    iconAnchor: [16, 32], // Point of the icon which corresponds to marker's location
                    popupAnchor: [0, -32] // Point from which the popup opens relative to the iconAnchor
                });
            };

            // --- 4. FETCH & RENDER ---
            try {
                // Fetch reports (Populating categories and severity is important on backend)
                // If your backend getAll() doesn't populate, you might just get IDs
                const res = await hazardReportAPI.getAll(1, 200);
                const reports = res.data.reports || res.data || [];

                if (reports.length === 0) {
                    alert("No hazard reports found.");
                }

                const bounds = L.latLngBounds();

                reports.forEach(report => {
                    const coords = parseCoordinates(report.location);

                    if (coords) {
                        // Create Marker
                        const marker = L.marker(coords, {
                            icon: createCustomIcon(report.severity_id)
                        }).addTo(map);

                        // Popup Content
                        const categoryName = report.category_id?.name || 'Hazard';
                        const desc = report.description || 'No description provided';
                        const time = new Date(report.reported_at).toLocaleString();
                        const reporter = report.user_id?.fullName || report.user_id?.userName || 'Unknown User';

                        const popupContent = `
                            <div class="font-sans min-w-[200px]">
                                <div class="flex items-center gap-2 mb-2 border-b pb-2">
                                    <span class="material-symbols-rounded text-red-500 text-lg">crisis_alert</span>
                                    <h3 class="font-bold text-gray-800">${categoryName}</h3>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">${desc}</p>
                                <div class="text-xs text-gray-400 flex flex-col gap-1">
                                    <span>ðŸ‘¤ ${reporter}</span>
                                    <span>ðŸ•’ ${time}</span>
                                </div>
                                <a href="#" class="block mt-3 text-center bg-neutral-100 hover:bg-neutral-200 text-neutral-700 text-xs font-bold py-1.5 rounded-lg transition">
                                    View Details
                                </a>
                            </div>
                        `;

                        marker.bindPopup(popupContent);
                        bounds.extend(coords);
                        markers.push(marker);
                    }
                });

                // Fit map to show all markers if any exist
                if (markers.length > 0) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }

            } catch (error) {
                console.error("Map Data Error:", error);
                alert("Failed to load hazard reports.");
            } finally {
                loader.classList.add('hidden');
            }

            // --- 5. USER LOCATION BUTTON ---
            document.getElementById('myLocationBtn').addEventListener('click', () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        const { latitude, longitude } = pos.coords;

                        // Add blue dot for user
                        L.circleMarker([latitude, longitude], {
                            radius: 8,
                            fillColor: "#3b82f6",
                            color: "#fff",
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).addTo(map).bindPopup("You are here").openPopup();

                        map.flyTo([latitude, longitude], 15);
                    }, err => {
                        alert("Could not get your location.");
                    });
                }
            });

        });
    </script>
</body>

</html>