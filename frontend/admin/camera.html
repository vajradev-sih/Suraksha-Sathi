<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Safety Cam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: black;
            overflow: hidden;
            touch-action: none;
            font-family: 'Inter', sans-serif;
        }

        #camera-feed {
            transform: scaleX(-1);
            object-fit: cover;
        }

        /* Recording Animation */
        .record-ring {
            transition: all 0.3s ease;
        }

        .record-inner {
            transition: all 0.3s ease;
        }

        .recording .record-ring {
            width: 80px;
            height: 80px;
            transform: scale(1.1);
            border-color: rgba(239, 68, 68, 0.6);
        }

        .recording .record-inner {
            width: 30px;
            height: 30px;
            border-radius: 4px;
        }

        /* Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Glassmorphism for Modal */
        .glass-panel {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .animate-slide-up {
            animation: slideUp 0.3s ease-out forwards;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="h-screen w-full relative text-white select-none">

    <div class="absolute top-4 left-4 z-30">
        <a href="updated-home-page.html"
            class="flex items-center justify-center w-10 h-10 rounded-full bg-black/40 backdrop-blur-md border border-white/10 hover:bg-black/60 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
        </a>
    </div>

    <div id="status-toast"
        class="hidden absolute top-16 left-1/2 -translate-x-1/2 z-50 bg-black/80 px-4 py-2 rounded-full border border-white/10 flex items-center gap-2 transition-all">
        <div id="status-dot" class="w-2 h-2 rounded-full bg-blue-500"></div>
        <p id="status-text" class="text-xs font-medium">Ready</p>
    </div>

    <video id="camera-feed" class="absolute inset-0 h-full w-full" autoplay playsinline muted></video>

    <div
        class="absolute bottom-0 left-0 right-0 z-20 flex flex-col items-center pb-12 pt-20 bg-gradient-to-t from-black via-black/50 to-transparent">
        <div class="w-full px-12 flex items-center justify-between max-w-md">

            <div class="flex flex-col items-center justify-center w-16">
                <input type="file" id="file-input" accept="video/*" class="hidden">
                <button id="upload-btn"
                    class="w-12 h-12 rounded-full bg-white/10 backdrop-blur-sm border border-white/20 flex items-center justify-center mb-1 active:scale-95 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                </button>
                <span class="text-[10px] font-medium text-white/70 uppercase tracking-wide">Upload</span>
            </div>

            <button id="record-btn" class="relative flex items-center justify-center mx-4">
                <div class="record-ring w-20 h-20 rounded-full border-[4px] border-white transition-all"></div>
                <div
                    class="record-inner absolute w-16 h-16 bg-red-600 rounded-full shadow-[0_0_20px_rgba(220,38,38,0.5)]">
                </div>
            </button>

            <div class="w-16"></div>
        </div>
    </div>

    <div id="details-modal"
        class="hidden absolute inset-0 z-40 bg-black/60 backdrop-blur-sm flex flex-col justify-end sm:justify-center items-center">
        <div class="glass-panel w-full sm:w-[400px] sm:rounded-2xl p-6 pb-10 sm:pb-6 animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold">Add Safety Details</h3>
                <button id="close-modal" class="p-2 text-white/50 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <form id="details-form" class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-400 mb-1 ml-1">Title (Required)</label>
                    <input type="text" id="video-title" required placeholder="e.g. Broken Fence at Site B"
                        class="w-full bg-white/10 border border-white/10 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-blue-500 transition-colors placeholder-white/30">
                </div>

                <div>
                    <label class="block text-xs text-gray-400 mb-1 ml-1">Description</label>
                    <textarea id="video-desc" rows="3" placeholder="Describe the hazard or safety observation..."
                        class="w-full bg-white/10 border border-white/10 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-blue-500 transition-colors placeholder-white/30 resize-none"></textarea>
                </div>

                <div class="pt-2">
                    <button type="submit" id="confirm-upload-btn"
                        class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3.5 rounded-xl transition-all active:scale-[0.98] flex items-center justify-center gap-2">
                        <span>Upload Video</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="17 8 12 3 7 8" />
                            <line x1="12" y1="3" x2="12" y2="15" />
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="loading-overlay"
        class="hidden absolute inset-0 z-50 bg-black/90 flex flex-col items-center justify-center">
        <div class="spinner mb-6"></div>
        <h3 class="text-xl font-bold mb-2">Uploading Video</h3>
        <p class="text-white/50 text-sm">Please keep the app open...</p>
    </div>

    <script src="../api.client.js"></script>

    <script>
        // --- API Definition (as requested) ---
        // Ensuring this exists if api.client.js is missing or doesn't have it yet
        if (typeof safetyVideoAPI === 'undefined') {
            window.safetyVideoAPI = {
                upload: (formData) => apiRequest("/api/v1/safety-videos/upload", { method: "POST", body: formData }),
                getAll: () => apiRequest("/api/v1/safety-videos", { method: "GET" }),
                update: (id, data) => apiRequest(`/api/v1/safety-videos/${id}`, { method: "PUT", body: JSON.stringify(data) }),
                delete: (id) => apiRequest(`/api/v1/safety-videos/${id}`, { method: "DELETE" }),
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- Elements ---
            const videoElement = document.getElementById('camera-feed');
            const recordBtn = document.getElementById('record-btn');
            const uploadBtn = document.getElementById('upload-btn');
            const fileInput = document.getElementById('file-input');

            const modal = document.getElementById('details-modal');
            const form = document.getElementById('details-form');
            const closeModalBtn = document.getElementById('close-modal');
            const loadingOverlay = document.getElementById('loading-overlay');
            const statusToast = document.getElementById('status-toast');
            const statusText = document.getElementById('status-text');
            const statusDot = document.getElementById('status-dot');

            // --- State ---
            let stream = null;
            let mediaRecorder = null;
            let chunks = [];
            let isRecording = false;
            let pendingFile = null; // Stores file waiting for details

            // --- UI Helpers ---
            function showToast(msg, type = 'info') {
                statusText.textContent = msg;
                statusDot.className = `w-2 h-2 rounded-full ${type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'}`;
                statusToast.classList.remove('hidden');
                setTimeout(() => statusToast.classList.add('hidden'), 3000);
            }

            function openDetailsModal(file) {
                pendingFile = file;
                // Auto-fill title with timestamp
                document.getElementById('video-title').value = `Site Recording - ${new Date().toLocaleTimeString()}`;
                modal.classList.remove('hidden');
            }

            function closeDetailsModal() {
                modal.classList.add('hidden');
                form.reset();
                pendingFile = null;
            }

            // --- 1. Camera Init ---
            async function initCamera() {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment', width: { ideal: 720 } },
                        audio: true
                    });
                    videoElement.srcObject = stream;
                } catch (err) {
                    console.error("Camera error:", err);
                    showToast("Camera access denied", "error");
                }
            }
            initCamera();

            // --- 2. Recording Logic ---
            recordBtn.addEventListener('click', () => {
                if (!stream) return;

                if (isRecording) {
                    // STOP Recording
                    mediaRecorder.stop();
                    isRecording = false;
                    recordBtn.classList.remove('recording');
                    showToast("Processing video...", "info");
                } else {
                    // START Recording
                    const mimeType = MediaRecorder.isTypeSupported('video/webm; codecs=vp9') ? 'video/webm; codecs=vp9' : 'video/webm';

                    mediaRecorder = new MediaRecorder(stream, { mimeType });
                    chunks = [];

                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) chunks.push(e.data);
                    };

                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'video/webm' });
                        const file = new File([blob], `safety_rec_${Date.now()}.webm`, { type: 'video/webm' });
                        openDetailsModal(file); // Open modal instead of uploading immediately
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    recordBtn.classList.add('recording');
                    showToast("Recording...", "error"); // Red dot for recording
                }
            });

            // --- 3. File Upload (Gallery) ---
            uploadBtn.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    openDetailsModal(e.target.files[0]);
                }
            });

            closeModalBtn.addEventListener('click', closeDetailsModal);

            // --- 4. Form Submit & API Call ---
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!pendingFile) return;

                // 1. Prepare Data
                const title = document.getElementById('video-title').value;
                const desc = document.getElementById('video-desc').value;

                const formData = new FormData();
                formData.append('file', pendingFile); // API expects 'file' (from multer middleware)
                formData.append('title', title);
                formData.append('description', desc);
                // Optional: Geo-location could be added here if needed

                // 2. UI Updates
                closeDetailsModal();
                loadingOverlay.classList.remove('hidden');

                // 3. Call API
                try {
                    // Using the safetyVideoAPI defined above
                    const response = await safetyVideoAPI.upload(formData);

                    showToast("Video uploaded successfully!", "success");
                    console.log("Upload success:", response);

                    setTimeout(() => {
                        loadingOverlay.classList.add('hidden');
                        // Optional: window.location.href = 'video_library.html';
                    }, 1000);

                } catch (error) {
                    console.error("Upload failed:", error);
                    loadingOverlay.classList.add('hidden');
                    showToast(error.message || "Upload failed. Please try again.", "error");
                }
            });
        });
    </script>
</body>

</html>