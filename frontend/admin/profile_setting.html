<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Profile &amp; Settings</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;700&amp;display=swap" rel="stylesheet" />
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#FFBF00",
            "background-light": "#f5f5f5",
            "background-dark": "#333333",
          },
          fontFamily: {
            "display": ["Public Sans", "sans-serif"]
          },
          borderRadius: {
            "DEFAULT": "0.25rem",
            "lg": "0.5rem",
            "xl": "0.75rem",
            "full": "9999px"
          },
        },
      },
    }
  </script>
  <style>
    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24
    }
  </style>
  <style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display">
  <div class="relative flex h-auto min-h-screen w-full flex-col group/design-root overflow-x-hidden">
    <!-- Top App Bar -->
    <div
      class="flex items-center bg-background-light dark:bg-background-dark p-4 pb-2 justify-between sticky top-0 z-10">
      <div id="back-btn" class="text-gray-800 dark:text-white flex size-12 shrink-0 items-center">
        <span class="material-symbols-outlined text-2xl">arrow_back</span>
      </div>
      <h2 class="text-gray-800 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">
        Profile &amp; Settings</h2>
      <div class="flex size-12 shrink-0 items-center"></div>
    </div>
    <!-- Profile Header -->
    <div class="flex p-4 @container">
      <div class="flex w-full flex-col gap-4 items-center">
        <div class="flex gap-4 flex-col items-center">
          <div id="profile-picture" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full min-h-32 w-32"
            data-alt="User's profile picture"
            style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCV-TFiTKLsbBsav0CYGfX49GoxWnvkegM579f4jJ5pbrhXMsddyR5v8AXM-qTqNrDw8WMZJlZxB3lSky3o5S7vOuhfTpDvZIZxYxCEGuQO86lIRCxgsjatY3WxGC_jDlJ2DAcAIhCqK0BOqP-9K5bZWKwCWy-TBuOnSubpiLCTixMG3PIaIoRUx5WvdsqIz0RPuj2cC8Ylp1XgkcJhygS5dcbGkVRb3SRpnP7U4QozJVT2WYTfGtiRHw57CojXLutxvkdOImPvPGI");'>
          </div>
          <div class="flex flex-col items-center justify-center">
            <p id="profile-name"
              class="text-gray-800 dark:text-white text-[22px] font-bold leading-tight tracking-[-0.015em] text-center">
              Alex Johnson</p>
            <p id="profile-role" class="text-gray-500 dark:text-gray-400 text-base font-normal leading-normal text-center">Blaster</p>
          </div>
        </div>
      </div>
    </div>
    <!-- Personal Information Section -->
    <div class="px-4">
      <h3 class="text-gray-800 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] pb-2 pt-4">Personal
        Information</h3>
      <div class="flex flex-col bg-white dark:bg-[#444444] rounded-lg">
        <div
          class="flex items-center gap-4 px-4 min-h-14 justify-between border-b border-gray-200 dark:border-gray-600">
          <div class="flex items-center gap-4">
            <div
              class="text-gray-800 dark:text-white flex items-center justify-center rounded-lg bg-gray-200 dark:bg-gray-700 shrink-0 size-10">
              <span class="material-symbols-outlined text-2xl">badge</span>
            </div>
            <p class="text-gray-800 dark:text-white text-base font-normal leading-normal flex-1 truncate">Employee ID
            </p>
          </div>
          <div class="flex items-center gap-2">
            <p id="employee-id" class="text-gray-500 dark:text-gray-400 text-base font-normal leading-normal">54321</p>
          </div>
        </div>
        <div
          class="flex items-center gap-4 px-4 min-h-14 justify-between border-b border-gray-200 dark:border-gray-600">
          <div class="flex items-center gap-4">
            <div
              class="text-gray-800 dark:text-white flex items-center justify-center rounded-lg bg-gray-200 dark:bg-gray-700 shrink-0 size-10">
              <span class="material-symbols-outlined text-2xl">email</span>
            </div>
            <p class="text-gray-800 dark:text-white text-base font-normal leading-normal flex-1 truncate">Email</p>
          </div>
          <div class="flex items-center gap-2">
            <p id="profile-email" class="text-gray-500 dark:text-gray-400 text-base font-normal leading-normal">alex.j@minecorp.com</p>
            <span class="material-symbols-outlined text-gray-400 dark:text-gray-500 text-xl cursor-pointer edit-field" data-field="email">edit</span>
          </div>
        </div>
        <div
          class="flex items-center gap-4 px-4 min-h-14 justify-between border-b border-gray-200 dark:border-gray-600">
          <div class="flex items-center gap-4">
            <div
              class="text-gray-800 dark:text-white flex items-center justify-center rounded-lg bg-gray-200 dark:bg-gray-700 shrink-0 size-10">
              <span class="material-symbols-outlined text-2xl">phone</span>
            </div>
            <p class="text-gray-800 dark:text-white text-base font-normal leading-normal flex-1 truncate">Phone</p>
          </div>
          <div class="flex items-center gap-2">
            <p id="profile-phone" class="text-gray-500 dark:text-gray-400 text-base font-normal leading-normal">(123) 456-7890</p>
            <span class="material-symbols-outlined text-gray-400 dark:text-gray-500 text-xl cursor-pointer edit-field" data-field="phone">edit</span>
          </div>
        </div>
        <div class="flex items-center gap-4 px-4 min-h-14 justify-between">
          <div class="flex items-center gap-4">
            <div
              class="text-gray-800 dark:text-white flex items-center justify-center rounded-lg bg-gray-200 dark:bg-gray-700 shrink-0 size-10">
              <span class="material-symbols-outlined text-2xl">contact_emergency</span>
            </div>
            <p class="text-gray-800 dark:text-white text-base font-normal leading-normal flex-1 truncate">Emergency
              Contact</p>
          </div>
          <div class="flex items-center gap-2">
            <p id="emergency-contact" class="text-gray-500 dark:text-gray-400 text-base font-normal leading-normal">(098) 765-4321</p>
            <span class="material-symbols-outlined text-gray-400 dark:text-gray-500 text-xl cursor-pointer edit-field" data-field="emergency">edit</span>
          </div>
        </div>
      </div>
    </div>
    <!-- App Preferences Section -->
    <div class="px-4">
      <h3 class="text-gray-800 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] pb-2 pt-4">App
        Preferences</h3>
      <div class="flex flex-col bg-white dark:bg-[#444444] rounded-lg">
        <div
          class="flex items-center gap-4 px-4 min-h-14 justify-between border-b border-gray-200 dark:border-gray-600">
          <div class="flex items-center gap-4">
            <div
              class="text-gray-800 dark:text-white flex items-center justify-center rounded-lg bg-gray-200 dark:bg-gray-700 shrink-0 size-10">
              <span class="material-symbols-outlined text-2xl">notifications</span>
            </div>
            <p class="text-gray-800 dark:text-white text-base font-normal leading-normal flex-1 truncate">Notification
              Settings</p>
          </div>
          <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
            <input checked=""
              class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
              id="toggle" name="toggle" type="checkbox" />
            <label
              class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 dark:bg-gray-500 cursor-pointer"
              for="toggle"></label>
          </div>
        </div>
        <div class="flex items-center gap-4 px-4 min-h-14 justify-between">
          <div class="flex items-center gap-4">
            <div
              class="text-gray-800 dark:text-white flex items-center justify-center rounded-lg bg-gray-200 dark:bg-gray-700 shrink-0 size-10">
              <span class="material-symbols-outlined text-2xl">language</span>
            </div>
            <p class="text-gray-800 dark:text-white text-base font-normal leading-normal flex-1 truncate">Language</p>
          </div>
          <div class="flex items-center gap-2">
            <select id="languageSelect" class="text-gray-500 dark:text-gray-400 text-base font-normal leading-normal bg-transparent border-0">
              <option value="en">English</option>
              <option value="hi">Hindi</option>
              <option value="es">Spanish</option>
            </select>
            <span class="material-symbols-outlined text-gray-400 dark:text-gray-500 text-xl cursor-pointer">arrow_forward_ios</span>
          </div>
        </div>
      </div>
    </div>
    <!-- Help & Support Section -->
    <div class="px-4">
      <h3 class="text-gray-800 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] pb-2 pt-4">Help &amp;
        Support</h3>
      <div class="flex flex-col bg-white dark:bg-[#444444] rounded-lg">
        <div
          class="flex items-center gap-4 px-4 min-h-14 justify-between border-b border-gray-200 dark:border-gray-600 cursor-pointer">
          <div class="flex items-center gap-4">
            <div
              class="text-gray-800 dark:text-white flex items-center justify-center rounded-lg bg-gray-200 dark:bg-gray-700 shrink-0 size-10">
              <span class="material-symbols-outlined text-2xl">help_center</span>
            </div>
            <p class="text-gray-800 dark:text-white text-base font-normal leading-normal flex-1 truncate">Help Center
            </p>
          </div>
          <span class="material-symbols-outlined text-gray-400 dark:text-gray-500 text-xl">arrow_forward_ios</span>
        </div>
        <div class="flex items-center gap-4 px-4 min-h-14 justify-between cursor-pointer">
          <div class="flex items-center gap-4">
            <div
              class="text-gray-800 dark:text-white flex items-center justify-center rounded-lg bg-gray-200 dark:bg-gray-700 shrink-0 size-10">
              <span class="material-symbols-outlined text-2xl">report</span>
            </div>
            <p class="text-gray-800 dark:text-white text-base font-normal leading-normal flex-1 truncate">Report a
              Problem</p>
          </div>
          <span class="material-symbols-outlined text-gray-400 dark:text-gray-500 text-xl">arrow_forward_ios</span>
        </div>
      </div>
    </div>
    <!-- Account Management Section -->
    <div class="p-4 mt-4">
      <button id="logout-btn"
        class="w-full bg-primary text-gray-800 font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2">
        <span class="material-symbols-outlined">logout</span>
        Log Out
      </button>
    </div>
  </div>
  <style>
    .toggle-checkbox:checked {
      right: 0;
      border-color: #FFBF00;
    }

    .toggle-checkbox:checked+.toggle-label {
      background-color: #FFBF00;
    }
  </style>

  <!-- Edit Field Modal -->
  <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-[#333333] rounded-xl p-4 w-full max-w-sm mx-4">
      <h3 id="edit-modal-title" class="text-lg font-bold mb-4 text-gray-800 dark:text-white">Edit Field</h3>
      <div class="mb-4">
        <input id="edit-field-input" type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-[#444444] dark:text-white">
      </div>
      <div class="flex justify-end gap-2">
        <button id="edit-modal-cancel" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-gray-800 dark:text-white">Cancel</button>
        <button id="edit-modal-save" class="px-4 py-2 bg-primary rounded-lg text-gray-800">Save</button>
      </div>
    </div>
  </div>

  <script src="../api.client.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // --- 1. AUTHENTICATION & ELEMENT SELECTION ---
      const token = localStorage.getItem("token");
      if (!token) {
        window.location.href = "../index.html";
        return;
      }

      // --- 2. DOM ELEMENTS ---
      const profileName = document.getElementById("profile-name");
      const profileRole = document.getElementById("profile-role");
      const employeeId = document.getElementById("employee-id");
      const profileEmail = document.getElementById("profile-email");
      const profilePhone = document.getElementById("profile-phone");
      const emergencyContact = document.getElementById("emergency-contact");
      const profilePicture = document.getElementById("profile-picture");
      const backBtn = document.getElementById("back-btn");
      const logoutBtn = document.getElementById("logout-btn");
      const editModal = document.getElementById("edit-modal");
      const editModalTitle = document.getElementById("edit-modal-title");
      const editFieldInput = document.getElementById("edit-field-input");
      const editModalCancel = document.getElementById("edit-modal-cancel");
      const editModalSave = document.getElementById("edit-modal-save");
      const notificationToggle = document.querySelector('#toggle');
      const languageSelect = document.querySelector('#languageSelect');

      // Current field being edited
      let currentEditField = null;

      // --- 3. RENDER FUNCTION ---
      const renderProfile = (user) => {
        if (!user) return;
        profileName.textContent = user.fullName || 'N/A';
        profileRole.textContent = user.role_name || 'N/A';
        employeeId.textContent = user._id ? user._id.slice(-6).toUpperCase() : 'N/A';
        profileEmail.textContent = user.email || 'N/A';
        profilePhone.textContent = user.phone || 'N/A';
        // Use a placeholder for emergency contact since it's not in the user object
        emergencyContact.textContent = user.emergencyContact || 'N/A';
        
        if (profilePicture) {
          profilePicture.style.backgroundImage = `url('https://api.dicebear.com/7.x/avataaars/svg?seed=${user.userName || 'default'}')`;
        }
      };

      // --- 4. API CALLS ---
      const initializePage = async () => {
        try {
          const response = await authAPI.getCurrentUser();
          renderProfile(response.data);
        } catch (error) {
          console.error("Failed to fetch user data:", error);
          alert("Could not load your profile. Please log in again.");
          if (error.message && error.message.includes("401")) {
            localStorage.clear();
            window.location.href = "../index.html";
          }
        }
      };

      // --- 5. EDIT FIELD FUNCTIONALITY ---
      const openEditModal = (field) => {
        currentEditField = field;
        let currentValue = '';
        let title = 'Edit Field';

        switch (field) {
          case 'email':
            currentValue = profileEmail.textContent;
            title = 'Edit Email';
            break;
          case 'phone':
            currentValue = profilePhone.textContent;
            title = 'Edit Phone Number';
            break;
          case 'emergency':
            currentValue = emergencyContact.textContent;
            title = 'Edit Emergency Contact';
            break;
        }

        editModalTitle.textContent = title;
        editFieldInput.value = currentValue;
        editModal.classList.remove('hidden');
      };

      const closeEditModal = () => {
        editModal.classList.add('hidden');
        currentEditField = null;
      };

      const saveField = async () => {
        const newValue = editFieldInput.value.trim();
        if (!newValue) return;

        try {
          // Here you would update the field on the server with an API call
          // await userManagementAPI.updateField(currentEditField, newValue);
          
          // Update local UI
          switch (currentEditField) {
            case 'email':
              profileEmail.textContent = newValue;
              break;
            case 'phone':
              profilePhone.textContent = newValue;
              break;
            case 'emergency':
              emergencyContact.textContent = newValue;
              break;
          }
          
          alert("Field updated successfully!");
          closeEditModal();
        } catch (error) {
          console.error("Failed to update field:", error);
          alert("Failed to update field. Please try again.");
        }
      };

      // --- 6. EVENT LISTENERS ---
      // Back button
      backBtn.addEventListener('click', () => history.back());

      // Logout button
      logoutBtn.addEventListener('click', async () => {
        try {
          await authAPI.logout();
        } catch (error) {
          console.error("Server logout failed, clearing session locally.", error);
        } finally {
          localStorage.removeItem("token");
          localStorage.removeItem("user");
          window.location.href = "../index.html";
        }
      });

      // Edit field buttons
      document.querySelectorAll('.edit-field').forEach(icon => {
        icon.addEventListener('click', () => {
          const field = icon.dataset.field;
          openEditModal(field);
        });
      });

      // Edit modal buttons
      editModalCancel.addEventListener('click', closeEditModal);
      editModalSave.addEventListener('click', saveField);
      
      // Notification toggle
      notificationToggle.addEventListener('change', (e) => {
        alert('Notifications ' + (e.target.checked ? 'Enabled' : 'Disabled'));
      });

      // Language selector
      if (languageSelect) {
        languageSelect.addEventListener('change', (e) => {
          alert('Language changed to: ' + e.target.value);
          // Here you could set the language preference in localStorage
          localStorage.setItem('lang', e.target.value);
        });
        
        // Set initial language from localStorage if available
        const savedLang = localStorage.getItem('lang');
        if (savedLang) {
          languageSelect.value = savedLang;
        }
      }

      // --- 7. INITIALIZE PAGE ---
      initializePage();
    });
  </script>
</body>

</html>
