<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Hazard Management</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,0..200"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&display=swap" rel="stylesheet">
    <script id="tailwind-config">
        tailwind.config = {
            theme: {
                extend: {
                    colors: { "primary": "#0284c7", "alert-red": "#ef4444", "warning-yellow": "#facc15", "success-green": "#22c55e", "info-blue": "#3b82f6", "neutral-900": "#0f172a" },
                    fontFamily: { "sans": ["Inter", "sans-serif"], "orbitron": ["Orbitron", "sans-serif"] },
                },
            },
        };
    </script>
    <style>
        .material-symbols-rounded {
            font-variation-settings: "FILL" 1, "wght" 400, "GRAD" 0, "opsz" 24;
        }

        .badge {
            @apply inline-flex items-center text-xs font-bold px-2 py-0.5 rounded-full;
        }
    </style>
</head>

<body class="bg-neutral-100 font-sans text-neutral-800 min-h-screen">
    <div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden pb-20">
        <!-- Header -->
        <div
            class="sticky top-0 z-30 flex items-center bg-gradient-to-r from-[#020617] via-[#0f172a] to-[#000000] px-4 py-3 justify-between shadow-lg">
            <a href="admin-home.html" class="text-white"><span
                    class="material-symbols-rounded text-2xl">arrow_back</span></a>
            <h1 class="text-xl font-[Orbitron] tracking-widest text-white">Hazard Management</h1>
            <div class="w-12"></div>
        </div>

        <main class="flex-1 p-4">
            <!-- Filters and Search -->
            <div class="mb-4 space-y-3">
                <div class="relative">
                    <span
                        class="material-symbols-rounded absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400">search</span>
                    <input id="search-hazards" type="text" placeholder="Search by title or location..."
                        class="w-full pl-10 pr-4 py-3 bg-white border-neutral-200 border rounded-xl focus:ring-2 focus:ring-primary">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <select id="filter-severity"
                        class="w-full bg-white border-neutral-200 border rounded-xl py-3 pl-4 pr-10 focus:ring-2 focus:ring-primary">
                        <option value="all">All Severities</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                    <select id="filter-status"
                        class="w-full bg-white border-neutral-200 border rounded-xl py-3 pl-4 pr-10 focus:ring-2 focus:ring-primary">
                        <option value="all">All Statuses</option>
                        <option value="New">New</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                    </select>
                </div>
            </div>

            <!-- Hazard List -->
            <div id="hazard-list-full" class="space-y-3">
                <!-- Hazard items will be injected here -->
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav
            class="fixed bottom-0 left-0 right-0 bg-gradient-to-r from-[#020617] via-[#0f172a] to-[#000000] border-t border-white/10 shadow-lg z-20">
            <div class="flex justify-around">
                <a href="admin-home.html"
                    class="flex flex-col items-center justify-center pt-3 pb-2 w-1/4 text-neutral-400 hover:text-white">
                    <span class="material-symbols-rounded">dashboard</span><span
                        class="text-xs font-medium mt-1">Dashboard</span>
                </a>
                <a href="admin_hazards.html"
                    class="flex flex-col items-center justify-center pt-3 pb-2 w-1/4 text-primary">
                    <span class="material-symbols-rounded">warning</span><span
                        class="text-xs font-medium mt-1">Hazards</span>
                </a>
                <a href="manage-users.html"
                    class="flex flex-col items-center justify-center pt-3 pb-2 w-1/4 text-neutral-400 hover:text-white">
                    <span class="material-symbols-rounded">groups</span><span
                        class="text-xs font-medium mt-1">Workforce</span>
                </a>
                <a href="activity_admin.html"
                    class="flex flex-col items-center justify-center pt-3 pb-2 w-1/4 text-neutral-400 hover:text-white">
                    <span class="material-symbols-rounded">notifications</span><span
                        class="text-xs font-medium mt-1">Activity</span>
                </a>
            </div>
        </nav>
    </div>
    <script src="../api.client.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const hazardData = [
                { id: 'HAZ001', title: 'Exposed Wiring', location: 'Sector 4', reportedBy: 'Rohan Sharma', timeAgo: '15m ago', severity: 'High', icon: 'electric_bolt', status: 'New' },
                { id: 'HAZ002', title: 'Ventilation Fault', location: 'Main Tunnel', reportedBy: 'Priya Patel', timeAgo: '2h ago', severity: 'Medium', icon: 'gpp_maybe', status: 'New' },
                { id: 'HAZ003', title: 'Minor Gas Leak', location: 'Sector 2', reportedBy: 'Suresh Singh', timeAgo: '4h ago', severity: 'High', icon: 'gas_meter', status: 'In Progress' },
                { id: 'HAZ004', title: 'Unstable Scaffolding', location: 'Level 3', reportedBy: 'Anjali Gupta', timeAgo: '1d ago', severity: 'Medium', icon: 'construction', status: 'Resolved' },
                { id: 'HAZ005', title: 'Water Accumulation', location: 'Sector 4 Exit', reportedBy: 'Vikram Kumar', timeAgo: '2d ago', severity: 'Low', icon: 'water_drop', status: 'Resolved' },
            ];

            const hazardListContainer = document.getElementById('hazard-list-full');
            const searchInput = document.getElementById('search-hazards');
            const severityFilter = document.getElementById('filter-severity');
            const statusFilter = document.getElementById('filter-status');

            function renderHazards() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedSeverity = severityFilter.value;
                const selectedStatus = statusFilter.value;

                hazardListContainer.innerHTML = '';

                const filteredHazards = hazardData.filter(h => {
                    return (h.title.toLowerCase().includes(searchTerm) || h.location.toLowerCase().includes(searchTerm)) &&
                        (selectedSeverity === 'all' || h.severity === selectedSeverity) &&
                        (selectedStatus === 'all' || h.status === selectedStatus);
                });

                if (filteredHazards.length === 0) {
                    hazardListContainer.innerHTML = `<p class="text-center text-neutral-500 py-10">No hazards match your criteria.</p>`;
                    return;
                }

                filteredHazards.forEach(report => {
                    const severityClasses = { High: 'bg-alert-red/10 text-alert-red', Medium: 'bg-warning-yellow/20 text-yellow-600', Low: 'bg-info-blue/10 text-info-blue' };
                    const statusClasses = { New: 'bg-blue-100 text-blue-700', 'In Progress': 'bg-orange-100 text-orange-700', Resolved: 'bg-green-100 text-green-700' };

                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-2xl shadow-card flex items-start gap-4';
                    item.innerHTML = `
                    <div class="w-12 h-12 flex-shrink-0 flex items-center justify-center ${severityClasses[report.severity]} rounded-xl"><span class="material-symbols-rounded">${report.icon}</span></div>
                    <div class="flex-1">
                        <p class="font-bold text-neutral-800">${report.title}</p>
                        <p class="text-sm text-neutral-500">${report.location}</p>
                        <div class="mt-2 flex items-center gap-2 flex-wrap">
                             <span class="badge ${severityClasses[report.severity]}">${report.severity}</span>
                             <span class="badge ${statusClasses[report.status]}">${report.status}</span>
                        </div>
                    </div>
                    <div class="text-right text-xs text-neutral-400">${report.timeAgo}</div>
                `;
                    hazardListContainer.appendChild(item);
                });
            }

            searchInput.addEventListener('input', renderHazards);
            severityFilter.addEventListener('change', renderHazards);
            statusFilter.addEventListener('change', renderHazards);

            renderHazards();
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem("token");
            if (!token) {
                window.location.href = "../index.html";
                return;
            }

            let allHazards = []; // This will store the master list of hazards

            const hazardListContainer = document.getElementById('hazard-list-full');
            const searchInput = document.getElementById('search-hazards');
            const severityFilter = document.getElementById('filter-severity');
            const statusFilter = document.getElementById('filter-status');

            const renderHazards = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedSeverity = severityFilter.value;
                const selectedStatus = statusFilter.value;

                hazardListContainer.innerHTML = '';

                const filteredHazards = allHazards.filter(h => {
                    // 1. FIX: Safely access properties with fallbacks to empty strings
                    const description = h.description ? h.description : "";
                    const location = h.location ? h.location : "";

                    // 2. FIX: Handle severity object from populated API response
                    // The API returns 'severity_id' object with a 'level' property
                    const severityLevel = h.severity_id?.level || h.severity || "Low";

                    const searchMatch = description.toLowerCase().includes(searchTerm) || location.toLowerCase().includes(searchTerm);
                    const severityMatch = (selectedSeverity === 'all' || severityLevel === selectedSeverity);
                    const statusMatch = (selectedStatus === 'all' || h.status === selectedStatus);

                    return searchMatch && severityMatch && statusMatch;
                });

                if (filteredHazards.length === 0) {
                    hazardListContainer.innerHTML = `<p class="text-center text-neutral-500 py-10">No hazards match your criteria.</p>`;
                    return;
                }

                filteredHazards.forEach(report => {
                    const severityClasses = { High: 'bg-alert-red/10 text-alert-red', Medium: 'bg-warning-yellow/20 text-yellow-600', Low: 'bg-info-blue/10 text-info-blue' };
                    const statusClasses = { New: 'bg-blue-100 text-blue-700', 'In Progress': 'bg-orange-100 text-orange-700', Resolved: 'bg-green-100 text-green-700' };

                    // Resolve severity for display (handling both API object and potential flat string)
                    const severityVal = report.severity_id?.level || report.severity || "Low";

                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-2xl shadow-card flex items-start gap-4 cursor-pointer hover:shadow-lg transition-shadow';

                    // Format Date
                    const dateStr = new Date(report.createdAt).toLocaleDateString();

                    item.innerHTML = `
                    <div class="w-12 h-12 flex-shrink-0 flex items-center justify-center ${severityClasses[severityVal] || severityClasses.Low} rounded-xl">
                        <span class="material-symbols-rounded">warning</span>
                    </div>
                    <div class="flex-1">
                        <p class="font-bold text-neutral-800">${report.description || "No description provided"}</p>
                        <p class="text-sm text-neutral-500">${report.location || "Unknown Location"}</p>
                        <div class="mt-2 flex items-center gap-2 flex-wrap">
                            <span class="badge ${severityClasses[severityVal] || severityClasses.Low}">${severityVal}</span>
                            <span class="badge ${statusClasses[report.status] || ''}">${report.status}</span>
                        </div>
                    </div>
                    <div class="text-right text-xs text-neutral-400">${dateStr}</div>
                `;
                    hazardListContainer.appendChild(item);
                });
            }

            const initializePage = async () => {
                try {
                    const response = await hazardReportAPI.getAll();
                    allHazards = response.data || [];
                    renderHazards(); // Initial render
                } catch (error) {
                    console.error("Failed to fetch hazards:", error);
                    hazardListContainer.innerHTML = `<p class="text-center text-red-500 py-10">Failed to load hazard reports.</p>`;
                }
            };

            // Add event listeners to trigger re-rendering on filter changes
            searchInput.addEventListener('input', renderHazards);
            severityFilter.addEventListener('change', renderHazards);
            statusFilter.addEventListener('change', renderHazards);

            // Initial data fetch and render
            initializePage();
        });
    </script>
</body>

</html>