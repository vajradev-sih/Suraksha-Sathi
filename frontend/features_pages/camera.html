<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Safety Cam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: black;
            overflow: hidden;
            touch-action: none;
        }

        #camera-feed {
            transform: scaleX(-1);
            /* Mirror selfie */
            object-fit: cover;
        }

        /* Recording Animation */
        .record-ring {
            transition: all 0.3s ease;
        }

        .record-inner {
            transition: all 0.3s ease;
        }

        .recording .record-ring {
            width: 80px;
            height: 80px;
            transform: scale(1.1);
            border-color: rgba(255, 0, 0, 0.5);
        }

        .recording .record-inner {
            width: 30px;
            height: 30px;
            border-radius: 4px;
        }

        /* Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="h-screen w-full relative text-white font-sans select-none">

    <!-- Back Button (Top Left) -->
    <div class="absolute top-4 left-4 z-30">
        <a href="updated-home-page.html"
            class="flex items-center justify-center w-10 h-10 rounded-full bg-black/50 backdrop-blur-md border border-white/20 hover:bg-black/70 transition-all active:scale-95">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
        </a>
    </div>

    <div id="loading-overlay"
        class="hidden absolute inset-0 z-50 bg-black/80 flex-col items-center justify-center backdrop-blur-sm">
        <div class="spinner mb-4"></div>
        <p class="text-lg font-semibold">Uploading to Secure Cloud...</p>
        <p class="text-sm text-gray-400">Please wait</p>
    </div>

    <div id="status-toast"
        class="hidden absolute top-10 left-1/2 -translate-x-1/2 z-50 bg-gray-900/90 px-6 py-3 rounded-full shadow-lg border border-white/10 transition-opacity">
        <p id="status-text" class="text-sm font-medium">Status message</p>
    </div>

    <video id="camera-feed" class="absolute inset-0 h-full w-full" autoplay playsinline muted></video>

    <div
        class="absolute bottom-0 left-0 right-0 z-20 flex flex-col items-center pb-12 bg-gradient-to-t from-black/90 via-black/40 to-transparent pt-20">

        <div class="w-full px-12 flex items-center justify-between max-w-md">

            <div class="flex flex-col items-center justify-center w-16">
                <input type="file" id="file-input" accept="video/*" class="hidden">
                <button id="upload-btn"
                    class="w-12 h-12 rounded-xl border border-white/20 bg-white/10 backdrop-blur-md flex items-center justify-center mb-1 transition-all active:scale-95 hover:bg-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                </button>
                <span class="text-[10px] font-medium text-white/70 uppercase tracking-wide">Upload</span>
            </div>

            <button id="record-btn" class="relative flex items-center justify-center mx-4">
                <div class="record-ring w-20 h-20 rounded-full border-[5px] border-white transition-all"></div>
                <div
                    class="record-inner absolute w-16 h-16 bg-red-600 rounded-full transition-all shadow-[0_0_15px_rgba(220,38,38,0.6)]">
                </div>
            </button>

            <div class="flex flex-col items-center justify-center w-16 opacity-0 pointer-events-none">
                <div class="w-12 h-12"></div>
            </div>
        </div>
    </div>

    <script src="../api.client.js"></script>

    <script>
        // Define API Locally if file not loaded (For testing purpose)
        // In production, rely on src="../api.client.js"
        if (typeof safetyVideoAPI === 'undefined') {
            window.safetyVideoAPI = {
                upload: (formData) => apiRequest("/api/v1/safety-videos/upload", { method: "POST", body: formData }),
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            const videoElement = document.getElementById('camera-feed');
            const recordBtn = document.getElementById('record-btn');
            const uploadBtn = document.getElementById('upload-btn');
            const fileInput = document.getElementById('file-input');
            const loadingOverlay = document.getElementById('loading-overlay');
            const statusToast = document.getElementById('status-toast');
            const statusText = document.getElementById('status-text');

            let stream = null;
            let mediaRecorder = null;
            let chunks = [];
            let isRecording = false;

            // --- UI HELPERS ---
            function showToast(msg, isError = false) {
                statusText.textContent = msg;
                statusText.className = isError ? "text-red-400" : "text-green-400";
                statusToast.classList.remove('hidden');
                setTimeout(() => statusToast.classList.add('hidden'), 3000);
            }

            function toggleLoading(show) {
                if (show) loadingOverlay.classList.remove('hidden');
                else loadingOverlay.classList.add('hidden');
            }

            // --- 1. CAMERA INIT ---
            async function initCamera() {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment', width: { ideal: 1080 } }, // Use back camera for safety videos usually
                        audio: true
                    });
                    videoElement.srcObject = stream;
                    // Flip logic: if front camera, mirror it. If back, don't.
                    // Simplified here to just show feed.
                } catch (err) {
                    console.error("Camera error:", err);
                    showToast("Camera access denied", true);
                }
            }
            initCamera();

            // --- 2. UPLOAD HANDLER ---
            async function handleFileUpload(fileObj) {
                if (!fileObj) return;

                // Basic Validation
                if (fileObj.size > 50 * 1024 * 1024) { // 50MB limit example
                    showToast("File too large (Max 50MB)", true);
                    return;
                }

                toggleLoading(true);

                try {
                    // Create FormData
                    const formData = new FormData();
                    formData.append('file', fileObj);

                    // Add metadata (Optional: You could add prompt() here to ask user for title)
                    const timestamp = new Date().toLocaleString();
                    formData.append('title', `Site Recording - ${timestamp}`);
                    formData.append('description', 'Recorded via Mobile Safety App');

                    // Call API
                    const response = await safetyVideoAPI.upload(formData);

                    toggleLoading(false);
                    showToast("Video uploaded successfully!");
                    console.log("Upload result:", response);

                } catch (error) {
                    console.error("Upload failed", error);
                    toggleLoading(false);
                    // Check for 403 Forbidden (Roles issue)
                    if (error.message && error.message.includes('403')) {
                        showToast("Permission Denied: Admin/Safety Officer only", true);
                    } else {
                        showToast("Upload failed. Try again.", true);
                    }
                }
            }

            // --- 3. RECORDING LOGIC ---
            recordBtn.addEventListener('click', () => {
                if (!stream) return;

                if (isRecording) {
                    // STOP
                    mediaRecorder.stop();
                    isRecording = false;
                    recordBtn.classList.remove('recording');
                } else {
                    // START
                    // Check supported mime types
                    const mimeType = MediaRecorder.isTypeSupported('video/webm; codecs=vp9')
                        ? 'video/webm; codecs=vp9'
                        : 'video/webm';

                    mediaRecorder = new MediaRecorder(stream, { mimeType });
                    chunks = [];

                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) chunks.push(e.data);
                    };

                    mediaRecorder.onstop = () => {
                        // Create Blob
                        const blob = new Blob(chunks, { type: 'video/webm' });

                        // Convert Blob to File (Required by Multer/Cloudinary often to detect extension)
                        const file = new File([blob], `safety_rec_${Date.now()}.webm`, { type: 'video/webm' });

                        // Trigger Upload
                        handleFileUpload(file);
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    recordBtn.classList.add('recording');
                }
            });

            // --- 4. GALLERY UPLOAD LOGIC ---
            uploadBtn.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleFileUpload(file);
            });
        });
    </script>
</body>

</html>