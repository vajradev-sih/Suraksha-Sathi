<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pre-Shift Vehicle Inspection</title>
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,0..200"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <style>
    body {
      min-height: max(884px, 100dvh);
    }

    #historyOverlay,
    #noteOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 50;
    }

    #historyContent,
    #noteContent {
      background: white;
      max-width: 400px;
      margin: 10vh auto;
      border-radius: 0.75rem;
      padding: 1rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .progress-bar {
      transition: width 0.5s ease-in-out;
    }

    .bg-progress-green {
      background-color: #22c55e;
    }

    /* Green for progress */
  </style>
</head>

<body class="bg-background-light font-sans">

  <div class="relative flex h-auto min-h-screen w-full flex-col bg-gray-50 overflow-x-hidden">
    <header
      class="sticky top-0 z-50 flex items-center bg-gradient-to-r from-[#020617] via-[#0f172a] to-[#000000] px-4 py-3 justify-between shadow-lg">
      <div class="flex size-12 shrink-0 items-center justify-start">
        <button id="backBtn" class="text-white"><span class="material-symbols-rounded">arrow_back</span></button>
      </div>
      <div class="flex-1 flex justify-center">
        <h1 id="checklist-title" class="text-lg text-center sm:text-xl font-[Orbitron] tracking-widest text-white" data-translate-key="checklist_page_title">
          Checklist</h1>
      </div>
      <div class="flex w-12 items-center justify-end">
        <button id="historyBtn" class="text-white"><span class="material-symbols-rounded">history</span></button>
      </div>
    </header>

    <div class="flex flex-col gap-3 p-4">
      <div class="flex justify-between items-center">
        <p class="text-gray-600 text-sm font-normal" data-translate-key="overall_progress">Overall Progress</p>
        <p id="overallProgressText" class="text-gray-800 text-sm font-bold">0% completed</p>
      </div>
      <div class="rounded-full bg-gray-200">
        <div id="overallProgressBar" class="h-2 rounded-full bg-progress-green progress-bar" style="width:0%"></div>
      </div>
    </div>

    <div id="checklistContainer" class="px-4 flex-grow bg-white mx-4 rounded-xl shadow-sm overflow-hidden">
      <div class="text-center py-10 text-gray-500" data-translate-key="loading_checklist">Loading checklist...</div>
    </div>

    <div
      class="sticky bottom-0 bg-white/80 backdrop-blur-sm p-4 mt-8 shadow-[0_-2px_10px_rgba(0,0,0,0.05)] flex flex-col gap-2">
      <button id="addNoteBtn"
        class="flex w-full items-center justify-center rounded-lg h-10 px-4 bg-blue-600 text-white gap-2 hover:bg-blue-700 transition-colors">
        <span class="material-symbols-outlined text-xl">add_comment</span>
        <span data-translate-key="add_note_btn">Add Note</span>
      </button>
      <button id="submitBtn"
        class="w-full rounded-lg h-12 bg-red-600 text-white font-bold hover:bg-red-700 transition-colors" data-translate-key="submit_report_btn">
        Submit Report
      </button>
    </div>
  </div>

  <!-- History Overlay -->
  <div id="historyOverlay">
    <div id="historyContent" class="flex flex-col">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold" data-translate-key="past_inspections">Past Inspections</h3>
        <button id="closeHistoryBtn" class="text-gray-600">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div id="historyItems" class="max-h-96 overflow-y-auto">
        <!-- History items will be populated dynamically -->
      </div>
    </div>
  </div>

  <!-- Note Overlay -->
  <div id="noteOverlay">
    <div id="noteContent" class="flex flex-col">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold" data-translate-key="add_note_modal">Add Note</h3>
        <button id="closeNoteBtn" class="text-gray-600">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <textarea id="noteText" rows="4" class="w-full border rounded-md p-2 mb-4"
        placeholder="Type your note here..."></textarea>
      <div class="flex justify-end gap-2">
        <button id="cancelNoteBtn" class="px-4 py-2 rounded border border-gray-300"
          data-translate-key="cancel_button">Cancel</button>
        <button id="saveNoteBtn" class="px-4 py-2 rounded bg-blue-600 text-white"
          data-translate-key="save_button">Save</button>
      </div>
    </div>
  </div>

  <script src="../api.client.js"></script>
  <script src="language-toggle.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- 1. AUTHENTICATION & ELEMENT SELECTION ---
      const token = localStorage.getItem("token");
      
      // Only check for token existence, not the specific structure of user object
      if (!token) {
        console.log("Redirecting: No authentication token found");
        window.location.href = "../index.html";
        return;
      }
      
      // Parse user data separately, with fallback for role_id
      const userData = localStorage.getItem("user");
      const user = userData ? JSON.parse(userData) : {};
      // Default to null if role_id doesn't exist
      const userRoleId = user.role_id || null;

      // --- 2. UI ELEMENTS ---
      const backBtn = document.getElementById("backBtn");
      const historyBtn = document.getElementById("historyBtn");
      const historyOverlay = document.getElementById("historyOverlay");
      const closeHistoryBtn = document.getElementById("closeHistoryBtn");
      const checklistContainer = document.getElementById("checklistContainer");
      const checklistTitle = document.getElementById("checklist-title");
      const overallProgressBar = document.getElementById("overallProgressBar");
      const overallProgressText = document.getElementById("overallProgressText");
      const submitBtn = document.getElementById("submitBtn");
      const addNoteBtn = document.getElementById("addNoteBtn");
      const noteOverlay = document.getElementById("noteOverlay");
      const closeNoteBtn = document.getElementById("closeNoteBtn");
      const cancelNoteBtn = document.getElementById("cancelNoteBtn");
      const saveNoteBtn = document.getElementById("saveNoteBtn");
      const noteText = document.getElementById("noteText");
      
      let currentChecklistId = null;
      // Add notes array to store the notes
      let checklistNotes = [];

      // --- 4. FUNCTIONS ---
      const renderChecklistItems = (items) => {
        checklistContainer.innerHTML = ""; // Clear loader
        if (!items || items.length === 0) {
          checklistContainer.innerHTML = `<div class="text-center py-10 text-gray-500">No items in this checklist.</div>`;
          return;
        }

        items.forEach((item, index) => {
          const isChecked = item.status === 'Completed';
          const itemHTML = `
            <label class="flex gap-x-4 py-4 items-center cursor-pointer">
              <input class="task-checkbox h-6 w-6 rounded-md border-gray-300 text-primary focus:ring-primary" 
                type="checkbox" data-item-id="${item._id}" ${isChecked ? 'checked' : ''}/>
              <p class="text-gray-800 text-base font-normal flex-1">${item.item_text}</p>
            </label>
            ${index < items.length - 1 ? '<div class="border-t border-gray-200"></div>' : ''}
          `;
          checklistContainer.insertAdjacentHTML('beforeend', itemHTML);
        });

        // Add event listeners after rendering
        document.querySelectorAll('.task-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', (e) => {
            updateProgress();
            debounceUpdate(e.target.dataset.itemId, e.target.checked);
          });
        });

        updateProgress(); // Initial progress calculation
      };

      const updateProgress = () => {
        const checkboxes = document.querySelectorAll(".task-checkbox");
        if (checkboxes.length === 0) return;
        
        const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
        const percent = Math.round((checkedCount / checkboxes.length) * 100);

        overallProgressBar.style.width = `${percent}%`;
        
        const currentLang = window.getCurrentLanguage ? window.getCurrentLanguage() : 'en';
        const completedTemplate = window.translations && window.translations.percent_completed 
            ? window.translations.percent_completed[currentLang] 
            : "{percent}% completed";
        overallProgressText.textContent = completedTemplate.replace('{percent}', percent);
      };

      const updateChecklistItemStatus = async (itemId, isChecked) => {
        try {
          const status = isChecked ? 'Completed' : 'Pending';
          console.log(`Updating item ${itemId} to status: ${status}`);
          await checklistItemAPI.update(itemId, { status });
        } catch (error) {
          console.error(`Failed to update item ${itemId}:`, error);
          alert("Failed to save progress. Please check your connection.");
        }
      };

      // Debounce function to prevent rapid API calls
      let debounceTimeout;
      const debounceUpdate = (itemId, isChecked) => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
          updateChecklistItemStatus(itemId, isChecked);
        }, 500); // 500ms delay
      };

      // Add function to load saved notes
      const loadNotes = () => {
        const savedNotes = localStorage.getItem(`checklist_notes_${currentChecklistId}`);
        if (savedNotes) {
          try {
            checklistNotes = JSON.parse(savedNotes);
          } catch (e) {
            console.error("Error parsing saved notes:", e);
            checklistNotes = [];
          }
        }
      };

      // Add function to save notes
      const saveNoteToStorage = (noteText) => {
        const newNote = {
          id: Date.now(), // Use timestamp as unique ID
          text: noteText,
          timestamp: new Date().toISOString(),
          checklistId: currentChecklistId
        };
        
        checklistNotes.push(newNote);
        localStorage.setItem(`checklist_notes_${currentChecklistId}`, JSON.stringify(checklistNotes));
        
        // Return the new note for UI updates
        return newNote;
      };

      // Add function to display notes
      const displayNotes = () => {
        const historyItems = document.getElementById("historyItems");
        historyItems.innerHTML = '';
        
        if (checklistNotes.length === 0) {
          historyItems.innerHTML = '<p class="text-gray-500 text-center py-4">No notes added yet.</p>';
          return;
        }
        
        // Sort notes by timestamp (newest first)
        checklistNotes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        checklistNotes.forEach(note => {
          const date = new Date(note.timestamp);
          const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
          
          const noteElement = document.createElement('div');
          noteElement.className = 'border-b border-gray-200 py-3';
          noteElement.innerHTML = `
            <p class="text-sm text-gray-500 mb-1">${formattedDate}</p>
            <p class="text-gray-800">${note.text}</p>
            <button class="delete-note text-red-600 text-sm mt-2" data-note-id="${note.id}">
              Delete
            </button>
          `;
          historyItems.appendChild(noteElement);
        });
        
        // Add event listeners to delete buttons
        document.querySelectorAll('.delete-note').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const noteId = parseInt(e.target.dataset.noteId);
            deleteNote(noteId);
          });
        });
      };

      // Add function to delete a note
      const deleteNote = (noteId) => {
        checklistNotes = checklistNotes.filter(note => note.id !== noteId);
        localStorage.setItem(`checklist_notes_${currentChecklistId}`, JSON.stringify(checklistNotes));
        displayNotes();
      };

      // --- 5. API CALLS ---
      const fetchChecklistData = async () => {
        try {
          // Use a more defensive approach when fetching checklists
          // If role_id doesn't exist, attempt to fetch without it
          let checklistsResponse;
          
          if (userRoleId) {
            checklistsResponse = await checklistAPI.getAll(userRoleId, null, 1, 1);
          } else {
            // Try fetching without role_id or with a default parameter
            checklistsResponse = await checklistAPI.getAll(null, null, 1, 1);
            // If your API requires a role_id, modify this accordingly
          }

          if (checklistsResponse.data && checklistsResponse.data.length > 0) {
            const checklist = checklistsResponse.data[0];
            currentChecklistId = checklist._id;
            checklistTitle.textContent = checklist.name; 

            // Load notes after setting currentChecklistId
            loadNotes();

            // Fetch the items for this specific checklist
            const itemsResponse = await checklistItemAPI.getByChecklist(currentChecklistId);
            if (itemsResponse.data) {
              renderChecklistItems(itemsResponse.data);
            }
          } else {
            checklistContainer.innerHTML = `<div class="text-center py-10 text-gray-500">No checklists assigned to you.</div>`;
          }
        } catch (error) {
          console.error("Failed to fetch checklist data:", error);
          checklistContainer.innerHTML = `<div class="text-center py-10 text-gray-500">Error loading checklist. Please try again later.</div>`;
        }
      };

      // --- 6. EVENT LISTENERS ---
      backBtn.addEventListener("click", () => history.back());
      
      historyBtn.addEventListener("click", () => { 
        historyOverlay.style.display = "block";
        displayNotes(); 
      });
      
      closeHistoryBtn.addEventListener("click", () => { 
        historyOverlay.style.display = "none"; 
      });
      
      historyOverlay.addEventListener("click", (e) => {
        if (e.target === historyOverlay) historyOverlay.style.display = "none";
      });
      
      // Add Note button functionality
      addNoteBtn.addEventListener("click", () => { 
        noteOverlay.style.display = "block"; 
        noteText.focus();
      });
      
      closeNoteBtn.addEventListener("click", () => { 
        noteOverlay.style.display = "none"; 
      });
      
      cancelNoteBtn.addEventListener("click", () => { 
        noteText.value = "";
        noteOverlay.style.display = "none"; 
      });
      
      noteOverlay.addEventListener("click", (e) => {
        if (e.target === noteOverlay) noteOverlay.style.display = "none";
      });
      
      // Enable keyboard shortcuts for notes
      noteText.addEventListener("keydown", (e) => {
        // Submit note with Ctrl+Enter
        if (e.key === "Enter" && e.ctrlKey) {
          saveNoteBtn.click();
        }
        // Cancel with Escape
        if (e.key === "Escape") {
          cancelNoteBtn.click();
        }
      });
      
      saveNoteBtn.addEventListener("click", () => {
        const note = noteText.value.trim();
        if (note) {
          const newNote = saveNoteToStorage(note);
          
          // Show confirmation and clear input
          const savedMsg = document.createElement('div');
          savedMsg.className = 'bg-green-100 text-green-800 p-2 rounded mb-2 text-center';
          savedMsg.textContent = 'Note saved successfully!';
          noteContent.insertBefore(savedMsg, noteContent.querySelector('.flex.justify-end').nextSibling);
          
          // Remove confirmation message after 2 seconds
          setTimeout(() => {
            savedMsg.remove();
          }, 2000);
          
          noteText.value = "";
        }
        
        // Don't hide the overlay right away if there's a confirmation message
        setTimeout(() => {
          noteOverlay.style.display = "none";
        }, 1000);
      });

      submitBtn.addEventListener("click", () => {
        alert("Report Submitted! All checklist progress has been saved.");
        // Optional: Redirect after submission
        // window.location.href = 'updated-home-page.html';
      });

      // --- 7. INITIALIZE THE PAGE ---
      applyLanguage(currentLang);
      fetchChecklistData();
    });
  </script>
</body>

</html>