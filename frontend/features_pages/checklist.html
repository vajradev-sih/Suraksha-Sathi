<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Safety Checklist</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,0..200"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&display=swap" rel="stylesheet">

  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#0284c7",
            "primary-dark": "#0369a1",
            "secondary": "#f97316",
            "surface-light": "#ffffff",
            "neutral-50": "#f8fafc",
            "neutral-900": "#0f172a",
            "success-green": "#22c55e",
            "alert-red": "#ef4444",
          },
          fontFamily: {
            "sans": ["Inter", "sans-serif"],
            "orbitron": ["Orbitron", "sans-serif"],
          },
        },
      },
    };
  </script>
  <style>
    .material-symbols-rounded {
      font-variation-settings: "FILL" 1, "wght" 400, "GRAD" 0, "opsz" 24;
    }

    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .check-item {
      transition: all 0.2s ease;
    }

    .check-item:active {
      transform: scale(0.98);
    }
  </style>
</head>

<body class="bg-neutral-50 font-sans text-neutral-800 min-h-screen pb-24">

  <div
    class="sticky top-0 z-50 flex items-center bg-gradient-to-r from-[#020617] via-[#0f172a] to-[#000000] px-4 py-3 justify-between shadow-lg">
    <a href="updated-home-page.html" class="text-white">
      <span class="material-symbols-rounded text-2xl">arrow_back</span>
    </a>
    <h1 class="text-xl font-[Orbitron] tracking-widest text-white">
      <span data-translate-key="checklist_title">My Checklists</span>
    </h1>
  </div>

  <main class="p-4 space-y-4">

    <div class="bg-white p-4 rounded-2xl shadow-sm border border-neutral-100 flex justify-between items-center">
      <div>
        <p class="text-xs text-neutral-500 uppercase font-bold" data-translate-key="pending_tasks">Pending Tasks</p>
        <p class="text-2xl font-bold text-primary" id="pending-count">0</p>
      </div>
      <div>
        <p class="text-xs text-neutral-500 uppercase font-bold text-right">Done Today</p>
        <p class="text-2xl font-bold text-success-green text-right" id="completed-count">0</p>
      </div>
    </div>

    <div id="checklist-container" class="space-y-3">
      <div class="text-center py-10 text-neutral-400">
        <span class="material-symbols-rounded text-4xl animate-spin">progress_activity</span>
        <p class="mt-2">Loading your tasks...</p>
      </div>
    </div>
  </main>

  <div id="executionModal" class="fixed inset-0 z-[60] bg-neutral-50 hidden flex-col overflow-hidden">

    <div class="bg-white px-4 py-3 shadow-md border-b border-neutral-100 flex justify-between items-center shrink-0">
      <div>
        <h2 class="font-bold text-lg text-neutral-800 leading-tight" id="modalTitle">Inspection</h2>
        <p class="text-xs text-neutral-500" id="modalSubtitle">Please complete all required items</p>
      </div>
      <button onclick="closeModal()"
        class="w-10 h-10 flex items-center justify-center rounded-full bg-neutral-100 text-neutral-600">
        <span class="material-symbols-rounded">close</span>
      </button>
    </div>

    <div class="flex-1 overflow-y-auto p-4 space-y-4" id="modalItems">
    </div>

    <div class="bg-white p-4 border-t border-neutral-200 shrink-0">
      <button id="submitChecklistBtn"
        class="w-full bg-primary text-white font-bold py-4 rounded-xl shadow-lg shadow-primary/30 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
        <span class="material-symbols-rounded">check_circle</span>
        <span data-translate-key="submit_inspection">Submit Inspection</span>
      </button>
    </div>
  </div>

  <input type="file" id="mediaInput" accept="image/*,video/*" class="hidden">

  <div id="toast"
    class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-neutral-800 text-white px-4 py-2 rounded-lg text-sm shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-[70]">
    Notification
  </div>

  <script src="../api.client.js"></script>
  <script src="language-toggle.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- 1. AUTH & INIT ---
      const token = localStorage.getItem("token");
      const user = JSON.parse(localStorage.getItem("user") || '{}');
      const roleId = user.role_id;

      if (!token) { window.location.href = "../index.html"; return; }

      // State
      let currentChecklistId = null;
      let currentItems = [];
      let currentMediaItem = null;

      // LOAD LOCAL STORAGE COMPLETED ITEMS
      let completedChecklists = JSON.parse(localStorage.getItem('completed_checklists') || '[]');

      // DOM
      const container = document.getElementById('checklist-container');
      const modal = document.getElementById('executionModal');
      const modalItems = document.getElementById('modalItems');
      const mediaInput = document.getElementById('mediaInput');
      const submitBtn = document.getElementById('submitChecklistBtn');

      // --- 2. DATA LOADING ---
      const loadData = async () => {
        try {
          // Update Stats from Local Storage
          const today = new Date().toDateString();
          const doneToday = completedChecklists.filter(c => new Date(c.timestamp).toDateString() === today).length;
          document.getElementById('completed-count').textContent = doneToday;

          // Fetch API Data
          const res = await checklistAPI.getAll(roleId);
          const checklists = res.data.checklists || [];

          renderList(checklists);

          // Calculate pending (Total API items - Locally Completed items)
          const pending = checklists.filter(c => !completedChecklists.some(done => done.id === c._id)).length;
          document.getElementById('pending-count').textContent = pending;

        } catch (e) {
          console.error(e);
          container.innerHTML = `<div class="text-center py-10 text-alert-red"><p>Failed to load tasks.</p></div>`;
        }
      };

      const renderList = (list) => {
        container.innerHTML = '';
        if (list.length === 0) {
          container.innerHTML = `<div class="text-center py-10 text-neutral-400"><p>No checklists assigned.</p></div>`;
          return;
        }

        list.forEach(cl => {
          // Check if this specific checklist ID is in our completed array
          const isDone = completedChecklists.some(done => done.id === cl._id);

          const card = document.createElement('div');

          // DIFFERENT STYLING FOR COMPLETED ITEMS
          if (isDone) {
            card.className = 'bg-green-50 p-4 rounded-2xl shadow-sm border border-green-200 relative overflow-hidden opacity-75';
            card.onclick = () => showToast("This inspection is complete.", "info");
          } else {
            card.className = 'bg-white p-4 rounded-2xl shadow-sm border border-neutral-100 active:scale-[0.99] transition-transform cursor-pointer relative overflow-hidden';
            card.onclick = () => openChecklist(cl);
          }

          const taskName = cl.task_id?.taskName || cl.name || 'Unnamed Task';

          // Badge Logic
          const badge = isDone
            ? `<span class="bg-green-200 text-green-800 text-[10px] font-bold px-2 py-1 rounded-full uppercase flex items-center gap-1"><span class="material-symbols-rounded text-xs">check</span>Done</span>`
            : `<span class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-1 rounded-full uppercase">Pending</span>`;

          const icon = isDone
            ? `<div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center"><span class="material-symbols-rounded">check_circle</span></div>`
            : `<div class="w-10 h-10 rounded-full bg-primary/10 text-primary flex items-center justify-center"><span class="material-symbols-rounded">play_arrow</span></div>`;

          card.innerHTML = `
                        <div class="absolute left-0 top-0 bottom-0 w-1.5 ${isDone ? 'bg-success-green' : 'bg-primary'}"></div>
                        <div class="flex justify-between items-center pl-3">
                            <div>
                                <h3 class="font-bold text-neutral-800 text-lg">${taskName}</h3>
                                <div class="flex items-center gap-2 mt-1">
                                    ${badge}
                                    <span class="text-xs text-neutral-500">${cl.name}</span>
                                </div>
                            </div>
                            ${icon}
                        </div>
                    `;
          container.appendChild(card);
        });
      };

      // --- 3. MODAL & ITEMS ---
      window.openChecklist = async (checklist) => {
        currentChecklistId = checklist._id;
        document.getElementById('modalTitle').textContent = checklist.name;
        modalItems.innerHTML = '<div class="text-center py-10"><span class="material-symbols-rounded animate-spin">refresh</span></div>';

        // Reset Button
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        submitBtn.innerHTML = `<span class="material-symbols-rounded">check_circle</span> <span data-translate-key="submit_inspection">Submit Inspection</span>`;

        modal.classList.remove('hidden');
        modal.classList.add('flex');

        try {
          const res = await checklistItemAPI.getByChecklist(checklist._id);
          currentItems = res.data || [];
          renderItems(currentItems);
        } catch (e) {
          modalItems.innerHTML = '<p class="text-center text-red-500">Error loading items</p>';
        }
      };

      window.closeModal = () => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      };

      const renderItems = (items) => {
        modalItems.innerHTML = '';

        if (items.length === 0) {
          modalItems.innerHTML = '<p class="text-center text-neutral-400 py-10">Empty Checklist</p>';
          return;
        }

        items.sort((a, b) => a.order - b.order);

        items.forEach(item => {
          const el = document.createElement('div');
          el.className = 'check-item bg-white p-4 rounded-xl border border-neutral-200 shadow-sm';
          el.innerHTML = `
                        <div class="flex items-start gap-3">
                            <input type="checkbox" id="check_${item._id}" class="mt-1 w-6 h-6 text-primary border-neutral-300 rounded focus:ring-primary transition" onchange="checkValidity()">
                            <div class="flex-1">
                                <label for="check_${item._id}" class="text-base font-medium text-neutral-800 block select-none">${item.description}</label>
                                ${item.is_mandatory ? '<span class="text-[10px] text-red-500 font-bold uppercase tracking-wider">Required</span>' : ''}
                                <div id="media_preview_${item._id}" class="mt-2 hidden"></div>
                                <div class="flex gap-2 mt-3">
                                    <button onclick="triggerCamera('${item._id}')" class="flex items-center gap-1 text-xs font-bold bg-neutral-100 text-neutral-600 px-3 py-2 rounded-lg hover:bg-neutral-200">
                                        <span class="material-symbols-rounded text-sm">photo_camera</span> Add Photo
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
          modalItems.appendChild(el);
        });
        checkValidity(); // Check immediately in case all optional
      };

      // --- 4. MEDIA UPLOAD LOGIC ---
      window.triggerCamera = (itemId) => {
        currentMediaItem = itemId;
        mediaInput.click();
      };

      mediaInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file || !currentMediaItem) return;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('checklist_item_id', currentMediaItem);

        showToast("Uploading...", "info");

        try {
          const res = await checklistItemMediaAPI.upload(formData);

          const previewContainer = document.getElementById(`media_preview_${currentMediaItem}`);
          previewContainer.classList.remove('hidden');
          previewContainer.innerHTML = `
                        <div class="relative w-20 h-20 rounded-lg overflow-hidden border border-neutral-200 mt-2">
                            <img src="${res.data.url}" class="w-full h-full object-cover">
                            <div class="absolute bottom-0 right-0 bg-green-500 text-white p-0.5 rounded-tl-md">
                                <span class="material-symbols-rounded text-xs">check</span>
                            </div>
                        </div>
                    `;

          const checkbox = document.getElementById(`check_${currentMediaItem}`);
          if (checkbox) {
            checkbox.checked = true;
            checkValidity();
          }
          showToast("Photo uploaded!");

        } catch (err) {
          console.error(err);
          showToast("Upload failed", "error");
        } finally {
          mediaInput.value = '';
        }
      });

      // --- 5. VALIDATION & SUBMIT ---
      window.checkValidity = () => {
        const mandatoryItems = currentItems.filter(i => i.is_mandatory);

        if (mandatoryItems.length === 0) {
          submitBtn.disabled = false;
          submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          return;
        }

        const allMandatoryChecked = mandatoryItems.every(i => {
          const cb = document.getElementById(`check_${i._id}`);
          return cb && cb.checked;
        });

        if (allMandatoryChecked) {
          submitBtn.disabled = false;
          submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
          submitBtn.disabled = true;
          submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
      };

      submitBtn.addEventListener('click', () => {
        if (submitBtn.disabled) return;

        submitBtn.innerHTML = `<span class="material-symbols-rounded animate-spin">sync</span> Submitting...`;

        // Simulate network request then Save Locally
        setTimeout(() => {
          // 1. Update Local Storage
          completedChecklists.push({
            id: currentChecklistId,
            timestamp: new Date().toISOString()
          });
          localStorage.setItem('completed_checklists', JSON.stringify(completedChecklists));

          // 2. UI Feedback
          closeModal();
          showToast("Inspection Submitted!");

          // 3. Refresh List to show Green Card
          loadData();

        }, 800);
      });

      const showToast = (msg, type = 'success') => {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = `fixed bottom-24 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg text-sm shadow-lg transition-opacity duration-300 z-[70] ${type === 'error' ? 'bg-red-600 text-white' : 'bg-neutral-800 text-white'}`;
        t.classList.remove('opacity-0');
        setTimeout(() => t.classList.add('opacity-0'), 3000);
      };

      // Init
      loadData();
    });
  </script>
</body>

</html>