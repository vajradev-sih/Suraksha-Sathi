<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MineSafe Hazard Report</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    .material-symbols-outlined {
      font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
    }

    body {
      min-height: 100vh;
    }

    /* Glassmorphism */
    .glass-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      border-radius: 1.25rem;
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: #222;
    }

    .glass-card-dark {
      background: rgba(30, 41, 59, 0.85);
      backdrop-filter: blur(12px);
      border-radius: 1.25rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    /* Inputs */
    .floating-label {
      position: relative;
    }

    .floating-label input,
    .floating-label textarea,
    .floating-label select {
      padding-top: 1.5rem;
      background: #f7fafc;
      color: #222;
    }

    .dark .floating-label input,
    .dark .floating-label textarea,
    .dark .floating-label select {
      background: #192833;
      color: white;
    }

    .floating-label label {
      position: absolute;
      left: 1rem;
      top: 1rem;
      font-size: 0.95rem;
      color: #888;
      pointer-events: none;
      transition: all 0.2s;
    }

    .floating-label input:focus+label,
    .floating-label input:not(:placeholder-shown)+label,
    .floating-label textarea:focus+label,
    .floating-label textarea:not(:placeholder-shown)+label,
    .floating-label select:focus+label,
    .floating-label select:valid+label {
      top: 0.2rem;
      left: 0.8rem;
      font-size: 0.75rem;
      color: #d97706;
      font-weight: 600;
      opacity: 1;
    }

    /* Severity Buttons */
    .severity-btn {
      background: #f7fafc;
      color: #222;
      transition: all 0.2s;
    }

    .dark .severity-btn {
      background: #192833;
      color: white;
    }

    #map {
      height: 250px;
      border-radius: 0.75rem;
      z-index: 1;
    }

    /* Animation */
    .step {
      display: none;
    }

    .step.active {
      display: block;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(10px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Progress Dots */
    .progress-dots {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 1.5rem;
    }

    .progress-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #cbd5e1;
      transition: background 0.3s;
    }

    .progress-dot.active {
      background: #eab308;
      transform: scale(1.2);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 5rem;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      min-width: 220px;
      background: rgba(30, 30, 30, 0.95);
      color: #fff;
      border-radius: 0.75rem;
      padding: 0.75rem 1.5rem;
      font-size: 0.9rem;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
      pointer-events: auto;
    }

    /* Carousel */
    .carousel {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      padding: 0.5rem 0;
    }

    .carousel-img {
      height: 5rem;
      width: 5rem;
      object-fit: cover;
      border-radius: 0.5rem;
    }

    .carousel-remove {
      position: absolute;
      top: -5px;
      right: -5px;
      background: red;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>

<body class="bg-gray-100 dark:bg-slate-900 font-display text-gray-900 dark:text-gray-100">

  <div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden">

    <header class="sticky top-0 z-50 flex items-center bg-slate-900 px-4 py-4 justify-between shadow-lg">
      <div class="flex size-12 shrink-0 items-center justify-start">
        <button id="backBtn" class="text-white hover:bg-white/10 p-2 rounded-full transition">
          <span class="material-symbols-outlined">arrow_back</span>
        </button>
      </div>
      <div class="flex-1 flex justify-center">
        <h1 class="text-lg sm:text-xl font-[Orbitron] tracking-wider text-white uppercase">Report Hazard</h1>
      </div>
      <div class="flex w-12 items-center justify-end"></div>
    </header>

    <div class="progress-dots mt-4">
      <div class="progress-dot active" id="dot0"></div>
      <div class="progress-dot" id="dot1"></div>
      <div class="progress-dot" id="dot2"></div>
      <div class="progress-dot" id="dot3"></div>
    </div>

    <main class="flex-1 px-4 pb-24">
      <form id="hazardForm" class="max-w-lg mx-auto">

        <div class="step active" id="step1">
          <div class="glass-card dark:glass-card-dark p-6 mb-4 shadow-sm">
            <div class="floating-label relative">
              <select id="hazard-category" name="hazard-category" required
                class="w-full rounded-lg border-gray-300 dark:border-slate-600 focus:ring-amber-500 focus:border-amber-500 transition appearance-none h-14 px-3 bg-gray-50 dark:bg-slate-800 text-gray-900 dark:text-white">
                <option value="" disabled selected></option>
                <option disabled>Loading categories...</option>
              </select>
              <label for="hazard-category">Hazard Category</label>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                <span class="material-symbols-outlined">expand_more</span>
              </div>
            </div>
          </div>

          <div class="glass-card dark:glass-card-dark p-6 mb-4 shadow-sm">
            <div class="floating-label mb-6 relative">
              <textarea id="hazard-description" name="hazard-description" rows="4" placeholder=" "
                class="w-full rounded-lg border-gray-300 dark:border-slate-600 focus:ring-amber-500 focus:border-amber-500 transition p-3 bg-gray-50 dark:bg-slate-800 text-gray-900 dark:text-white"></textarea>
              <label for="hazard-description">Describe the Hazard</label>
            </div>

            <!-- Audio Recording Section -->
            <div class="mb-6 p-4 bg-gray-50 dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-slate-600">
              <label class="block text-sm font-bold mb-3 text-gray-700 dark:text-gray-300 flex items-center gap-2">
                <span class="material-symbols-outlined">mic</span>
                Audio Description (Optional)
              </label>
              <div class="flex items-center gap-3">
                <button type="button" id="record-btn"
                  class="flex items-center gap-2 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all">
                  <span class="material-symbols-outlined">mic</span>
                  <span id="record-text">Start Recording</span>
                </button>
                <span id="recording-timer" class="hidden text-sm font-mono text-gray-700 dark:text-gray-300">00:00</span>
              </div>
              <audio id="audio-playback" class="hidden w-full mt-3" controls></audio>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Click to record your voice description of the hazard</p>
            </div>

            <div>
              <label class="block text-sm font-bold mb-3 text-gray-700 dark:text-gray-300">Severity Level</label>
              <div id="severity-buttons" class="grid grid-cols-3 gap-3">
                <button type="button"
                  class="severity-btn flex flex-col items-center justify-center gap-1 rounded-xl p-3 border-2 border-green-500/50 text-green-600 bg-green-50/50 selected"
                  data-label="Low">
                  <span class="material-symbols-outlined text-3xl">check_circle</span>
                  <span class="text-xs font-bold uppercase tracking-wide">Low</span>
                </button>
                <button type="button"
                  class="severity-btn flex flex-col items-center justify-center gap-1 rounded-xl p-3 border-2 border-transparent text-yellow-600"
                  data-label="Medium">
                  <span class="material-symbols-outlined text-3xl">warning</span>
                  <span class="text-xs font-bold uppercase tracking-wide">Medium</span>
                </button>
                <button type="button"
                  class="severity-btn flex flex-col items-center justify-center gap-1 rounded-xl p-3 border-2 border-transparent text-red-600"
                  data-label="High">
                  <span class="material-symbols-outlined text-3xl">dangerous</span>
                  <span class="text-xs font-bold uppercase tracking-wide">High</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="step" id="step2">
          <div class="glass-card dark:glass-card-dark p-6 mb-4 shadow-sm">
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-amber-500">location_on</span>
              <span>Location</span>
            </h3>

            <button type="button" id="getLocationBtn" onclick="getLocationAsync()"
              class="w-full mb-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg flex items-center justify-center gap-2 transition shadow-md">
              <span class="material-symbols-outlined">my_location</span>
              Use Current Location
            </button>

            <div class="floating-label mb-4">
              <input type="text" id="location" name="location" placeholder=" " readonly
                class="w-full rounded-lg border-gray-300 dark:border-slate-600 bg-gray-50 dark:bg-slate-800 text-gray-900 dark:text-white" />
              <label for="location">Coordinates</label>
            </div>
            <div id="map" class="mb-2 shadow-inner border border-gray-200 dark:border-slate-600"></div>
            <p class="text-xs text-gray-500 text-center mt-2">Tap button or drag marker to refine.</p>
          </div>
        </div>

        <div class="step" id="step3">
          <div class="glass-card dark:glass-card-dark p-6 mb-4 shadow-sm">
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-amber-500">perm_media</span>
              <span>Evidence (Optional)</span>
            </h3>
            <p class="text-sm text-gray-500 mb-4">Add photos and/or audio description</p>

            <!-- Photo Upload Section -->
            <div class="mb-6">
              <h4 class="font-semibold text-md mb-3 flex items-center gap-2">
                <span class="material-symbols-outlined text-blue-500">photo_camera</span>
                <span>Photos (Optional)</span>
              </h4>
              <button type="button" id="uploadBtn"
                class="flex h-32 w-full flex-col items-center justify-center rounded-xl border-2 border-dashed border-gray-400 dark:border-slate-500 hover:bg-amber-50 dark:hover:bg-slate-800 transition group">
                <div class="p-4 bg-gray-200 dark:bg-slate-700 rounded-full mb-2 group-hover:scale-110 transition">
                  <span class="material-symbols-outlined text-3xl text-gray-600 dark:text-gray-300">add_a_photo</span>
                </div>
                <span class="text-sm font-semibold text-gray-600 dark:text-gray-300">Tap to Upload Photos</span>
              </button>
              <div id="carouselPreview" class="carousel w-full mt-3 min-h-[6rem]"></div>
            </div>

            <!-- Audio Recording Section -->
            <div class="mb-4 border-t border-gray-200 dark:border-slate-600 pt-6">
              <h4 class="font-semibold text-md mb-3 flex items-center gap-2">
                <span class="material-symbols-outlined text-purple-500">mic</span>
                <span>Audio Description (Optional)</span>
              </h4>
              
              <div id="audioRecordingSection">
                <!-- Recording Controls -->
                <div id="recordingControls" class="flex flex-col gap-3">
                  <button type="button" id="startRecordBtn"
                    class="w-full py-4 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 text-white font-bold shadow-lg flex items-center justify-center gap-2 hover:shadow-xl transition">
                    <span class="material-symbols-outlined">mic</span>
                    <span>Start Recording</span>
                  </button>
                  
                  <button type="button" id="stopRecordBtn" style="display:none;"
                    class="w-full py-4 rounded-xl bg-gradient-to-r from-red-500 to-red-600 text-white font-bold shadow-lg flex items-center justify-center gap-2 animate-pulse">
                    <span class="material-symbols-outlined">stop_circle</span>
                    <span>Stop Recording</span>
                    <span id="recordingTimer" class="ml-2 font-mono">0:00</span>
                  </button>
                </div>

                <!-- Audio Preview -->
                <div id="audioPreviewSection" style="display:none;" class="mt-4 p-4 bg-gray-50 dark:bg-slate-800 rounded-lg">
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                      <span class="material-symbols-outlined text-purple-500">audio_file</span>
                      <span class="font-semibold text-sm">Audio Recording</span>
                    </div>
                    <button type="button" id="deleteAudioBtn" class="text-red-500 hover:text-red-700">
                      <span class="material-symbols-outlined">delete</span>
                    </button>
                  </div>
                  <audio id="audioPlayback" controls class="w-full"></audio>
                  <div class="text-xs text-gray-500 mt-2" id="audioInfo"></div>
                </div>
              </div>
            </div>

            <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden" multiple />
            <input type="file" id="fileInput" accept="image/*" class="hidden" multiple />
          </div>
        </div>

        <div class="step" id="step4">
          <div class="glass-card dark:glass-card-dark p-6 mb-4 shadow-sm">
            <h3
              class="text-lg font-bold mb-4 flex items-center gap-2 border-b pb-2 border-gray-200 dark:border-slate-600">
              <span class="material-symbols-outlined text-amber-500">assignment</span>
              <span>Review Report</span>
            </h3>

            <div class="space-y-4 text-sm">
              <div class="flex justify-between border-b border-gray-700/20 pb-2">
                <span class="text-gray-900 dark:text-gray-800">Category</span>
                <span id="previewCategory" class="font-bold text-right text-gray-900 dark:text-black text-base"></span>
              </div>

              <div class="flex justify-between border-b border-gray-700/20 pb-2">
                <span class="text-gray-900 dark:text-gray-800">Severity</span>
                <span id="previewSeverity" class="font-bold text-right text-gray-900 dark:text-black text-base"></span>
              </div>

              <div class="flex flex-col gap-1">
                <span class="text-gray-900 dark:text-gray-800">Description</span>
                <span id="previewDesc"
                  class="font-medium p-3 bg-gray-50 dark:bg-slate-800 rounded-lg block text-gray-900 dark:text-gray-100 text-base"></span>
              </div>

              <div class="flex flex-col gap-1">
                <span class="text-gray-900 dark:text-gray-800">Location</span>
                <span id="previewLocation"
                  class="font-mono text-xs p-3 bg-gray-50 dark:bg-slate-800 rounded-lg block break-all text-gray-900 dark:text-gray-300"></span>
              </div>

              <div>
                <span class="text-gray-900 dark:text-gray-800 mb-2 block">Photos</span>
                <div id="previewPhotos"
                  class="flex gap-2 flex-wrap min-h-[80px] bg-gray-50 dark:bg-slate-800 p-2 rounded-lg">
                </div>
              </div>

              <div id="previewAudioSection" style="display:none;">
                <span class="text-gray-900 dark:text-gray-800 mb-2 block">Audio Description</span>
                <div class="bg-gray-50 dark:bg-slate-800 p-3 rounded-lg flex items-center gap-2">
                  <span class="material-symbols-outlined text-purple-500">mic</span>
                  <span class="text-sm font-medium">Audio recording attached</span>
                  <span id="previewAudioDuration" class="text-xs text-gray-500"></span>
                </div>
              </div>
            </div>

          </div>
        </div>

      </form>
    </main>

    <div
      class="fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-900 p-4 border-t border-gray-200 dark:border-slate-800 flex justify-between shadow-lg z-40">
      <button id="prevBtn"
        class="px-6 py-3 rounded-xl bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-white font-bold transition opacity-50 cursor-not-allowed">Back</button>
      <button id="nextBtn"
        class="px-8 py-3 rounded-xl bg-gradient-to-r from-amber-500 to-orange-600 text-white font-bold shadow-lg shadow-amber-500/30 active:scale-95 transition">Next</button>
    </div>

    <div id="toast" class="toast"></div>

    <div id="confirmModal"
      class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100] hidden">
      <div class="glass-card dark:glass-card-dark p-6 rounded-2xl shadow-2xl max-w-xs w-full mx-4">
        <div class="text-center mb-4">
          <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <span class="material-symbols-outlined text-4xl text-amber-600">publish</span>
          </div>
          <h3 class="text-lg font-bold">Submit Report?</h3>
          <p class="text-sm text-gray-500 mt-2">This will be sent to supervisor immediately.</p>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <button id="cancelModalBtn"
            class="py-2.5 rounded-lg bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition">Cancel</button>
          <button id="confirmModalBtn"
            class="py-2.5 rounded-lg font-bold text-white bg-red-600 hover:bg-red-700 shadow-lg">Submit</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Scripts -->
  <script src="../offline-db.js"></script>
  <script src="../offline-ui.js"></script>
  <script src="../api.client.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {

      // --- VARIABLES ---
      let currentUser = null;
      let apiCategories = [];
      let apiSeverities = [];

      let currentLat = null;
      let currentLng = null;

      // DOM Elements
      const steps = Array.from(document.querySelectorAll(".step"));
      const dots = document.querySelectorAll(".progress-dot");
      const nextBtn = document.getElementById("nextBtn");
      const prevBtn = document.getElementById("prevBtn");
      const hazardCategorySelect = document.getElementById("hazard-category");
      const hazardDesc = document.getElementById("hazard-description");
      const locationInput = document.getElementById("location");
      const uploadBtn = document.getElementById("uploadBtn");
      const fileInput = document.getElementById("fileInput");

      // State
      let currentStep = 0;
      let selectedSeverityLabel = "Low";
      let photoFiles = [];
      let photoDataUrls = [];
      let map, marker, circle;
      
      // Audio recording state
      let mediaRecorder = null;
      let audioChunks = [];
      let audioBlob = null;
      let audioUrl = null;
      let recordingInterval = null;
      let recordingSeconds = 0;

      // --- 1. INITIALIZE DATA FROM API ---
      async function initApp() {
        try {
          // A. Get User
          const userResponse = await window.authAPI.getCurrentUser();
          currentUser = userResponse.data || userResponse.user || userResponse;
          if (!currentUser) {
            showToast("Please Log In First", "error");
          }

          console.log("Current User:", currentUser);

          // B. Get Categories
          const catResponse = await window.hazardCategoryAPI.getAll();
          apiCategories = catResponse.data || catResponse;

          hazardCategorySelect.innerHTML = '<option value="" disabled selected></option>';
          apiCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat._id; // MongoDB ID
            option.textContent = cat.name;
            hazardCategorySelect.appendChild(option);
          });

          // C. Get Severities
          const sevResponse = await window.severityTagAPI.getAll();
          apiSeverities = sevResponse.data || sevResponse;
          console.log("Severities Loaded:", apiSeverities);

        } catch (error) {
          console.error("Initialization Failed:", error);
          showToast("Error loading form data", "error");
        }
      }

      await initApp();
      showStep(currentStep);


      // --- 2. STEP NAVIGATION ---
      function showStep(n) {
        steps.forEach((step, i) => {
          step.classList.toggle('active', i === n);
        });
        dots.forEach((dot, i) => dot.classList.toggle('active', i === n));

        if (n === 1) {
          setTimeout(() => { if (map) map.invalidateSize(); }, 300);
        }

        prevBtn.disabled = n === 0;
        prevBtn.classList.toggle('opacity-50', n === 0);
        prevBtn.classList.toggle('cursor-not-allowed', n === 0);
        nextBtn.textContent = n === steps.length - 1 ? "Submit" : "Next";
      }

      nextBtn.addEventListener("click", () => {
        if (currentStep < steps.length - 1) {
          if (currentStep === 0) {
            if (!hazardCategorySelect.value) return showToast("Select a category", "error");
            if (!hazardDesc.value.trim()) return showToast("Describe the hazard", "error");
          }
          if (currentStep === 1 && !locationInput.value) {
            return showToast("Please set location", "error");
          }
          currentStep++;
          showStep(currentStep);
          if (currentStep === 3) updatePreview();
        } else {
          document.getElementById('confirmModal').classList.remove('hidden');
        }
      });

      prevBtn.addEventListener("click", () => {
        if (currentStep > 0) { currentStep--; showStep(currentStep); }
      });


      // --- 3. LOCATION ---
      window.getLocationAsync = function () {
        const btn = document.getElementById('getLocationBtn');
        btn.innerHTML = `<span class="material-symbols-outlined animate-spin">refresh</span> Finding...`;

        if (!navigator.geolocation) {
          showToast("Geolocation not supported", "error");
          resetLocBtn();
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            currentLat = pos.coords.latitude;
            currentLng = pos.coords.longitude;
            initMap(currentLat, currentLng);
            showToast("Location updated!", "success");
            resetLocBtn();
          },
          (err) => {
            console.warn(err);
            showToast("Could not get location. Check permissions.", "error");
            initMap(28.6139, 77.2090);
            resetLocBtn();
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      }

      function resetLocBtn() {
        const btn = document.getElementById('getLocationBtn');
        btn.innerHTML = `<span class="material-symbols-outlined">my_location</span> Use Current Location`;
      }

      function initMap(lat, lng) {
        currentLat = lat;
        currentLng = lng;
        locationInput.value = `${lat.toFixed(5)}, ${lng.toFixed(5)}`; // This string is sent as 'location'

        if (map) {
          map.setView([lat, lng], 17);
          if (marker) marker.setLatLng([lat, lng]);
          if (circle) circle.setLatLng([lat, lng]);
          return;
        }

        map = L.map('map').setView([lat, lng], 17);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
        marker = L.marker([lat, lng], { draggable: true }).addTo(map);
        circle = L.circle([lat, lng], { radius: 30, color: '#f59e0b', fillColor: '#f59e0b', fillOpacity: 0.2 }).addTo(map);

        marker.on('dragend', (e) => {
          const pos = e.target.getLatLng();
          currentLat = pos.lat;
          currentLng = pos.lng;
          locationInput.value = `${pos.lat.toFixed(5)}, ${pos.lng.toFixed(5)}`;
          circle.setLatLng(pos);
        });
      }


      // --- 4. SEVERITY BUTTONS ---
      document.querySelectorAll(".severity-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".severity-btn").forEach(b => {
            b.classList.remove("selected", "border-green-500/50", "border-yellow-500/50", "border-red-500/50", "bg-green-50/50", "bg-yellow-50/50", "bg-red-50/50", "text-green-600", "text-yellow-600", "text-red-600");
            if (b.dataset.label === 'Low') b.classList.add("text-green-600");
            if (b.dataset.label === 'Medium') b.classList.add("text-yellow-600");
            if (b.dataset.label === 'High') b.classList.add("text-red-600");
          });

          btn.classList.add("selected");
          selectedSeverityLabel = btn.dataset.label;
          if (selectedSeverityLabel === "Low") btn.classList.add("border-green-500/50", "bg-green-50/50");
          if (selectedSeverityLabel === "Medium") btn.classList.add("border-yellow-500/50", "bg-yellow-50/50");
          if (selectedSeverityLabel === "High") btn.classList.add("border-red-500/50", "bg-red-50/50");
        });
      });


      // --- 5. PHOTOS ---
      uploadBtn.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", (e) => {
        if (e.target.files) {
          Array.from(e.target.files).forEach(file => {
            photoFiles.push(file);
            const reader = new FileReader();
            reader.onload = (ev) => {
              photoDataUrls.push(ev.target.result);
              renderCarousel();
            };
            reader.readAsDataURL(file);
          });
        }
      });

      function renderCarousel() {
        const container = document.getElementById("carouselPreview");
        container.innerHTML = "";
        photoDataUrls.forEach((src, idx) => {
          const div = document.createElement("div");
          div.className = "relative flex-shrink-0";
          div.innerHTML = `<img src="${src}" class="carousel-img shadow-md"><span class="carousel-remove" onclick="removePhoto(${idx})">×</span>`;
          container.appendChild(div);
        });
      }

      window.removePhoto = (index) => {
        photoFiles.splice(index, 1);
        photoDataUrls.splice(index, 1);
        renderCarousel();
      };


      // --- 6. AUDIO RECORDING ---
      const startRecordBtn = document.getElementById('startRecordBtn');
      const stopRecordBtn = document.getElementById('stopRecordBtn');
      const deleteAudioBtn = document.getElementById('deleteAudioBtn');
      const audioPlayback = document.getElementById('audioPlayback');
      const audioPreviewSection = document.getElementById('audioPreviewSection');
      const recordingTimer = document.getElementById('recordingTimer');

      startRecordBtn.addEventListener('click', async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          
          // Determine supported MIME type
          let mimeType = 'audio/webm';
          if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
            mimeType = 'audio/webm;codecs=opus';
          } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
            mimeType = 'audio/mp4';
          } else if (MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')) {
            mimeType = 'audio/ogg;codecs=opus';
          }
          
          mediaRecorder = new MediaRecorder(stream, { mimeType });
          audioChunks = [];
          recordingSeconds = 0;

          mediaRecorder.addEventListener('dataavailable', (event) => {
            audioChunks.push(event.data);
          });

          mediaRecorder.addEventListener('stop', () => {
            audioBlob = new Blob(audioChunks, { type: mimeType });
            audioUrl = URL.createObjectURL(audioBlob);
            audioPlayback.src = audioUrl;
            
            // Show preview
            audioPreviewSection.style.display = 'block';
            document.getElementById('audioInfo').textContent = 
              `Duration: ${formatTime(recordingSeconds)} • Size: ${(audioBlob.size / 1024).toFixed(1)} KB`;
            
            // Stop all tracks
            stream.getTracks().forEach(track => track.stop());
            
            showToast('Recording saved', 'success');
          });

          mediaRecorder.start();
          startRecordBtn.style.display = 'none';
          stopRecordBtn.style.display = 'flex';
          
          // Start timer
          recordingInterval = setInterval(() => {
            recordingSeconds++;
            recordingTimer.textContent = formatTime(recordingSeconds);
          }, 1000);
          
          showToast('Recording started', 'info');
        } catch (error) {
          console.error('Microphone access error:', error);
          showToast('Microphone access denied', 'error');
        }
      });

      stopRecordBtn.addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
          stopRecordBtn.style.display = 'none';
          startRecordBtn.style.display = 'flex';
          clearInterval(recordingInterval);
        }
      });

      deleteAudioBtn.addEventListener('click', () => {
        if (confirm('Delete audio recording?')) {
          audioBlob = null;
          audioUrl = null;
          audioChunks = [];
          recordingSeconds = 0;
          audioPreviewSection.style.display = 'none';
          audioPlayback.src = '';
          showToast('Audio deleted', 'info');
        }
      });

      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }


      // --- 7. PREVIEW ---
      function updatePreview() {
        const catName = hazardCategorySelect.options[hazardCategorySelect.selectedIndex]?.text || "None";
        document.getElementById("previewCategory").textContent = catName;
        document.getElementById("previewSeverity").textContent = selectedSeverityLabel;
        document.getElementById("previewDesc").textContent = hazardDesc.value;
        document.getElementById("previewLocation").textContent = locationInput.value;

        const pContainer = document.getElementById("previewPhotos");
        pContainer.innerHTML = "";

        if (photoDataUrls.length === 0) {
          pContainer.innerHTML = "<span class='text-gray-500 italic'>No photos uploaded</span>";
        } else {
          photoDataUrls.forEach(src => {
            const img = document.createElement("img");
            img.src = src;
            img.className = "w-24 h-24 object-cover rounded-lg border-2 border-white dark:border-slate-600 shadow-sm";
            pContainer.appendChild(img);
          });
        }
        
        // Audio preview
        const audioPreview = document.getElementById('previewAudioSection');
        if (audioBlob) {
          audioPreview.style.display = 'block';
          document.getElementById('previewAudioDuration').textContent = `(${formatTime(recordingSeconds)})`;
        } else {
          audioPreview.style.display = 'none';
        }
      }


      // --- 8. SUBMIT LOGIC (UPDATED WITH AUDIO SUPPORT) ---
      document.getElementById("cancelModalBtn").addEventListener("click", () => document.getElementById("confirmModal").classList.add("hidden"));

      document.getElementById("confirmModalBtn").addEventListener("click", async () => {
        const confirmBtn = document.getElementById("confirmModalBtn");
        confirmBtn.disabled = true;
        confirmBtn.textContent = "Processing...";

        try {
          // A. Resolve Severity ID
          let sevId = null;
          if (apiSeverities && apiSeverities.length > 0) {
            const match = apiSeverities.find(s => {
              const name = s.name || s.tag_name || s.label || "";
              return name.toLowerCase() === selectedSeverityLabel.toLowerCase();
            });
            sevId = match ? match._id : apiSeverities[0]._id;
          } else {
            sevId = "dummy_id";
          }

          // B. Construct Payload - STRICTLY MATCHING REQUIREMENTS
          // B. Construct Payload - Force IDs to Strings
          const payload = {
            // 1. user_id: Force to String
            user_id: currentUser ? String(currentUser.id) : null,

            // 2. reported_at
            reported_at: new Date().toISOString(),

            // 3. location
            location: String(locationInput.value),

            // 4. category_id: Force to String
            category_id: String(hazardCategorySelect.value),

            // 5. severity_id: Force to String
            severity_id: String(sevId),

            // --- Additional Data ---
            description: hazardDesc.value, // MANDATORY
          };

          console.log("Submitting Payload:", payload);

          // C. Store offline if needed (with media)
          if (typeof offlineDB !== 'undefined') {
            const offlineData = {
              ...payload,
              photoCount: photoFiles.length,
              hasAudio: !!audioBlob,
              timestamp: Date.now()
            };
            
            // Save to IndexedDB for offline sync
            await offlineDB.saveHazardReport(offlineData);
            
            // Save media files
            if (photoFiles.length > 0) {
              for (let i = 0; i < photoFiles.length; i++) {
                await offlineDB.saveMediaFile(photoFiles[i], {
                  type: 'photo',
                  reportLocalId: offlineData.localId,
                  index: i
                });
              }
            }
            
            // Save audio file
            if (audioBlob) {
              await offlineDB.saveMediaFile(audioBlob, {
                type: 'audio',
                reportLocalId: offlineData.localId,
                duration: recordingSeconds
              });
            }
          }

          console.log("Serialized JSON (What the server sees):", JSON.stringify(payload));

          // D. API Call
          const reportResponse = await window.hazardReportAPI.create(payload);
          const reportId = reportResponse.data ? reportResponse.data._id : reportResponse._id;

          if (!reportId) throw new Error("Report created but no _id returned.");

          // E. Upload Media Files if online
          let uploadedCount = 0;
          
          // Upload Photos
          if (photoFiles.length > 0 && navigator.onLine) {
            showToast(`Uploading ${photoFiles.length} photo(s)...`, "info");
            for (const file of photoFiles) {
              try {
                const formData = new FormData();
                formData.append("file", file);
                formData.append("report_id", reportId);
                formData.append("media_type", "photo");
                await window.hazardMediaAPI.upload(formData);
                uploadedCount++;
              } catch (uploadError) {
                console.error("Photo upload failed:", uploadError);
              }
            }
          }
          
          // Upload Audio
          if (audioBlob && navigator.onLine) {
            showToast("Uploading audio...", "info");
            try {
              const formData = new FormData();
              const audioFile = new File([audioBlob], `audio_${Date.now()}.webm`, { 
                type: audioBlob.type 
              });
              formData.append("file", audioFile);
              formData.append("report_id", reportId);
              formData.append("media_type", "audio");
              formData.append("duration", recordingSeconds);
              await window.hazardMediaAPI.upload(formData);
              uploadedCount++;
            } catch (uploadError) {
              console.error("Audio upload failed:", uploadError);
            }
          }

          document.getElementById("confirmModal").classList.add("hidden");
          
          const successMsg = uploadedCount > 0 
            ? `Report submitted! ${uploadedCount} media file(s) uploaded.`
            : !navigator.onLine 
              ? "Report saved! Will sync when online."
              : "Report submitted successfully!";
          
          showToast(successMsg, "success");
          setTimeout(() => window.location.reload(), 2000);

        } catch (error) {
          console.error("Submission Error:", error);
          document.getElementById("confirmModal").classList.add("hidden");
          
          // Check if it was queued offline
          if (error.message && error.message.includes('queued')) {
            showToast("Report saved offline. Will sync when online.", "success");
            setTimeout(() => window.location.reload(), 2000);
          } else {
            showToast(error.message || "Submission failed", "error");
            confirmBtn.disabled = false;
            confirmBtn.textContent = "Submit";
          }
        }
      });


      // --- UTILS ---
      function showToast(msg, type = "info") {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.style.background = type === "error" ? "#ef4444" : type === "success" ? "#22c55e" : "#1f2937";
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 3000);
      }

    });
  </script>
</body>

</html>