<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Safety Cam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0"
        rel="stylesheet" />
    <style>
        :root {
            --primary: #F9A825;
            --accent: #22C55E;
            --danger: #EF4444;
        }

        body {
            background-color: #000;
            font-family: 'Inter', sans-serif;
            color: white;
            overflow: hidden;
        }

        /* Scroll Container */
        #shorts-container {
            height: 100dvh;
            width: 100%;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        #shorts-container::-webkit-scrollbar {
            display: none;
        }

        /* Individual Slide */
        .video-slide {
            height: 100dvh;
            width: 100%;
            position: relative;
            scroll-snap-align: start;
            scroll-snap-stop: always;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111;
            overflow: hidden;
        }

        video {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-height: 100%;
            min-width: 100%;
            width: auto;
            height: auto;
            object-fit: cover;
            pointer-events: none;
        }

        #camera-feed {
            /* Camera preview needs separate styling to sit behind UI but above nothing when recording */
            z-index: 1;
        }

        .short-video-element {
            /* Feed videos */
            z-index: 0;
        }

        /* UI Overlay Layer */
        .overlay-layer {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.3) 40%, transparent 100%);
            padding: 20px;
            pointer-events: none;
            z-index: 10;
        }

        .interactive {
            pointer-events: auto;
        }

        .actions-bar {
            position: absolute;
            right: 16px;
            bottom: 100px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            z-index: 20;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(4px);
            border: none;
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:active {
            transform: scale(0.9);
        }

        .action-btn.liked {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.2);
        }

        .action-btn.liked span {
            font-variation-settings: 'FILL' 1;
        }

        .action-label {
            font-size: 11px;
            margin-top: 4px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .info-area {
            width: 80%;
            margin-bottom: 20px;
            z-index: 10;
        }

        .tag {
            background: var(--primary);
            color: #000;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
            margin-bottom: 8px;
        }

        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 50;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.6), transparent);
            pointer-events: none;
        }

        .nav-btn {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            pointer-events: auto;
            text-decoration: none;
        }

        /* Camera Mode Styles */
        .camera-mode .video-slide {
            display: none;
        }

        .camera-mode #camera-ui {
            display: flex;
        }

        #camera-ui {
            display: none;
            /* Hidden by default */
            position: fixed;
            inset: 0;
            z-index: 40;
            flex-direction: column;
            justify-content: flex-end;
            background: black;
        }

        #camera-feed {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .record-ring {
            transition: all 0.3s ease;
            width: 80px;
            height: 80px;
            border: 5px solid white;
            border-radius: 50%;
        }

        .record-inner {
            transition: all 0.3s ease;
            width: 60px;
            height: 60px;
            background: #ef4444;
            border-radius: 50%;
        }

        .recording .record-ring {
            transform: scale(1.1);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .recording .record-inner {
            width: 30px;
            height: 30px;
            border-radius: 4px;
        }

        /* Progress Bar */
        .progress-track {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.2);
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.1s linear;
        }

        /* Modal & Loaders */
        .glass-panel {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div class="top-nav">
        <a href="updated-home-page.html" class="nav-btn">
            <span class="material-symbols-rounded">arrow_back</span>
        </a>
        <div class="mt-2 font-bold text-lg tracking-wide opacity-90 drop-shadow-md">
            Suraksha Shorts
        </div>
        <button id="open-camera-btn" class="nav-btn camera-btn interactive">
            <span class="material-symbols-rounded">add_a_photo</span>
        </button>
    </div>

    <div id="shorts-container">
    </div>

    <div id="camera-ui">
        <video id="camera-feed" autoplay playsinline muted></video>

        <div
            class="absolute bottom-0 left-0 right-0 z-50 flex flex-col items-center pb-12 pt-20 bg-gradient-to-t from-black via-black/50 to-transparent">
            <div class="w-full px-12 flex items-center justify-between max-w-md">
                <div class="flex flex-col items-center justify-center w-16">
                    <input type="file" id="file-input" accept="video/*" class="hidden">
                    <button id="upload-btn"
                        class="w-12 h-12 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center mb-1">
                        <span class="material-symbols-rounded">upload_file</span>
                    </button>
                    <span class="text-[10px] font-medium text-white/70 uppercase">Upload</span>
                </div>

                <button id="record-btn" class="relative flex items-center justify-center">
                    <div class="record-ring flex items-center justify-center">
                        <div class="record-inner"></div>
                    </div>
                </button>

                <button id="close-camera-btn" class="flex flex-col items-center justify-center w-16">
                    <div
                        class="w-12 h-12 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center mb-1">
                        <span class="material-symbols-rounded">close</span>
                    </div>
                    <span class="text-[10px] font-medium text-white/70 uppercase">Close</span>
                </button>
            </div>
        </div>
    </div>

    <div id="details-modal"
        class="hidden absolute inset-0 z-[60] bg-black/80 backdrop-blur-sm flex flex-col justify-end sm:justify-center items-center">
        <div class="glass-panel w-full sm:w-[400px] sm:rounded-2xl p-6 pb-10 sm:pb-6">
            <h3 class="text-lg font-bold mb-4">Add Safety Details</h3>
            <form id="details-form" class="space-y-4">
                <input type="text" id="video-title" required placeholder="Title (e.g. Site Hazard)"
                    class="w-full bg-white/10 border border-white/10 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-blue-500 text-white">
                <textarea id="video-desc" rows="3" placeholder="Description..."
                    class="w-full bg-white/10 border border-white/10 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-blue-500 text-white resize-none"></textarea>
                <button type="submit" id="confirm-upload-btn"
                    class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3 rounded-xl">Upload
                    Video</button>
            </form>
        </div>
    </div>

    <div id="toast"
        class="fixed top-20 left-1/2 -translate-x-1/2 bg-white/90 text-black px-6 py-2 rounded-full font-semibold text-sm opacity-0 transition-opacity duration-300 z-[100] pointer-events-none shadow-xl">
        Action Completed
    </div>

    <div id="loading-overlay"
        class="hidden absolute inset-0 z-[70] bg-black/90 flex flex-col items-center justify-center text-white">
        <div class="spinner mb-4"></div>
        <p>Uploading...</p>
    </div>

    <script src="../api.client.js"></script>

    <script>
        // --- API Definitions (Fallback) ---
        if (typeof workerVideoAPI === 'undefined') {
            window.workerVideoAPI = {
                upload: (formData) => apiRequest("/api/v1/worker-videos/upload", { method: "POST", body: formData }),
                getApproved: (page = 1, limit = 10) => apiRequest(`/api/v1/worker-videos/approved?page=${page}&limit=${limit}`, { method: "GET" })
            };
        }
        if (typeof safetyVideoAPI === 'undefined') {
            window.safetyVideoAPI = {
                getAll: () => apiRequest("/api/v1/safety-videos", { method: "GET" })
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem("token");
            if (!token) { window.location.href = "../index.html"; return; }

            // State
            let videoData = [];
            let stream = null;
            let mediaRecorder = null;
            let chunks = [];
            let isRecording = false;
            let pendingFile = null;
            let isMuted = true;

            // DOM
            const container = document.getElementById('shorts-container');
            const cameraUI = document.getElementById('camera-ui');
            const videoElement = document.getElementById('camera-feed');
            const recordBtn = document.getElementById('record-btn');

            // --- 1. DATA FETCHING ---
            const fetchFeed = async () => {
                try {
                    // Fetch Official Safety Videos
                    const safetyRes = await safetyVideoAPI.getAll().catch(e => ({ data: [] }));
                    const safetyVideos = (safetyRes.data || []).map(v => ({
                        id: v._id,
                        url: v.url,
                        poster: v.thumbnail_url || '',
                        category: "Official Safety",
                        title: v.title,
                        description: v.description,
                        uploader: "Safety Team",
                        likes: Math.floor(Math.random() * 500) + 100, // Mock stats
                        comments: Math.floor(Math.random() * 50)
                    }));

                    // Fetch Approved Worker Videos
                    const workerRes = await workerVideoAPI.getApproved(1, 20).catch(e => ({ data: [] }));
                    // Handle array or pagination object
                    const wData = Array.isArray(workerRes.data) ? workerRes.data : (workerRes.data?.videos || []);

                    const workerVideos = wData.map(v => ({
                        id: v._id,
                        url: v.video_url,
                        poster: v.thumbnail_url || '',
                        category: v.category || "Community",
                        title: v.title,
                        description: v.description,
                        uploader: v.uploaded_by?.fullName || "Worker",
                        likes: v.views || 0,
                        comments: 0
                    }));

                    // Combine and Shuffle
                    videoData = [...safetyVideos, ...workerVideos].sort(() => 0.5 - Math.random());

                    if (videoData.length === 0) {
                        container.innerHTML = '<div class="flex h-screen items-center justify-center text-gray-500">No videos available. Be the first to upload!</div>';
                    } else {
                        renderApp();
                    }

                } catch (e) {
                    console.error("Feed Error:", e);
                    container.innerHTML = '<div class="flex h-screen items-center justify-center text-red-500">Failed to load feed.</div>';
                }
            };

            // --- 2. RENDERING ---
            const renderApp = () => {
                container.innerHTML = videoData.map((video, index) => `
                    <div class="video-slide" id="slide-${index}">
                        <video src="${video.url}" poster="${video.poster}" loop muted playsinline class="short-video-element"></video>
                        
                        <div class="overlay-layer">
                            <div class="actions-bar interactive">
                                <div class="flex flex-col items-center">
                                    <button class="action-btn like-btn" onclick="toggleLike(this, ${video.likes})">
                                        <span class="material-symbols-rounded">favorite</span>
                                    </button>
                                    <span class="action-label">${video.likes}</span>
                                </div>
                                <div class="flex flex-col items-center">
                                    <button class="action-btn" onclick="shareVideo('${video.title}')">
                                        <span class="material-symbols-rounded">share</span>
                                    </button>
                                    <span class="action-label">Share</span>
                                </div>
                            </div>

                            <div class="info-area interactive">
                                <span class="tag">${video.category}</span>
                                <h2 class="text-xl font-bold mb-2 drop-shadow-lg">${video.title}</h2>
                                <p class="text-sm opacity-90 leading-snug line-clamp-2">${video.description || ''}</p>
                                <p class="text-xs mt-2 opacity-75">Posted by ${video.uploader}</p>
                            </div>

                            <div class="progress-track"><div class="progress-fill"></div></div>
                        </div>
                    </div>
                `).join('');

                initObserver();
            };

            // --- 3. VIDEO OBSERVER & LOGIC ---
            const initObserver = () => {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        const video = entry.target.querySelector('video');
                        if (entry.isIntersecting) {
                            video.currentTime = 0;
                            video.play().catch(e => console.log("Autoplay blocked"));
                        } else {
                            video.pause();
                        }
                    });
                }, { threshold: 0.6 });

                document.querySelectorAll('.video-slide').forEach(slide => {
                    observer.observe(slide);
                    // Click to Play/Pause
                    slide.addEventListener('click', (e) => {
                        if (e.target.closest('button')) return;
                        const v = slide.querySelector('video');
                        v.paused ? v.play() : v.pause();
                    });
                });
            };

            window.toggleLike = (btn, count) => {
                btn.classList.toggle('liked');
                // Just visual in this demo
                showToast(btn.classList.contains('liked') ? "Liked" : "Unliked");
            };

            window.shareVideo = (title) => {
                if (navigator.share) {
                    navigator.share({ title: title, url: window.location.href });
                } else {
                    navigator.clipboard.writeText(window.location.href);
                    showToast("Link copied!");
                }
            };

            function showToast(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.style.opacity = '1';
                setTimeout(() => t.style.opacity = '0', 2000);
            }

            // --- 4. CAMERA & UPLOAD LOGIC ---
            document.getElementById('open-camera-btn').addEventListener('click', async () => {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' },
                        audio: true
                    });
                    videoElement.srcObject = stream;
                    cameraUI.style.display = 'flex';
                } catch (e) {
                    showToast("Camera access denied");
                }
            });

            document.getElementById('close-camera-btn').addEventListener('click', () => {
                if (stream) stream.getTracks().forEach(t => t.stop());
                cameraUI.style.display = 'none';
            });

            recordBtn.addEventListener('click', () => {
                if (!stream) return;
                if (isRecording) {
                    mediaRecorder.stop();
                    isRecording = false;
                    recordBtn.classList.remove('recording');
                } else {
                    const mime = MediaRecorder.isTypeSupported('video/webm; codecs=vp9') ? 'video/webm; codecs=vp9' : 'video/webm';
                    mediaRecorder = new MediaRecorder(stream, { mimeType: mime });
                    chunks = [];
                    mediaRecorder.ondataavailable = e => chunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'video/webm' });
                        pendingFile = new File([blob], `rec_${Date.now()}.webm`, { type: 'video/webm' });
                        openDetailsModal();
                    };
                    mediaRecorder.start();
                    isRecording = true;
                    recordBtn.classList.add('recording');
                }
            });

            document.getElementById('upload-btn').addEventListener('click', () => document.getElementById('file-input').click());
            document.getElementById('file-input').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    pendingFile = e.target.files[0];
                    openDetailsModal();
                }
            });

            function openDetailsModal() {
                document.getElementById('details-modal').classList.remove('hidden');
                // Auto title
                document.getElementById('video-title').value = `Site Observation ${new Date().toLocaleTimeString()}`;
            }

            document.getElementById('details-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!pendingFile) return;

                document.getElementById('loading-overlay').classList.remove('hidden');
                document.getElementById('details-modal').classList.add('hidden');

                const formData = new FormData();
                formData.append('file', pendingFile);
                formData.append('title', document.getElementById('video-title').value);
                formData.append('description', document.getElementById('video-desc').value);

                try {
                    await workerVideoAPI.upload(formData);
                    showToast("Uploaded successfully!");
                    setTimeout(() => window.location.reload(), 1500);
                } catch (err) {
                    console.error(err);
                    showToast("Upload failed");
                    document.getElementById('loading-overlay').classList.add('hidden');
                }
            });

            // Init
            fetchFeed();
        });
    </script>
</body>

</html>