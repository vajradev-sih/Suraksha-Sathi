<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Offline Features Test - Suraksha Sathi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="manifest" href="./manifest.json">
  <style>
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    .status-online { background: #10b981; box-shadow: 0 0 10px #10b981; }
    .status-offline { background: #ef4444; box-shadow: 0 0 10px #ef4444; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">
        <span class="material-symbols-outlined align-middle">cloud_sync</span>
        Offline Features Test
      </h1>
      <p class="text-gray-600">Test and monitor offline capabilities of Suraksha Sathi</p>
    </div>

    <!-- Connection Status -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">Connection Status</h2>
      <div class="flex items-center mb-4">
        <span class="status-indicator" id="status-dot"></span>
        <span class="text-lg font-semibold" id="status-text">Checking...</span>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-gray-50 p-4 rounded">
          <div class="text-sm text-gray-600">Queue Length</div>
          <div class="text-2xl font-bold text-gray-800" id="queue-length">0</div>
        </div>
        <div class="bg-gray-50 p-4 rounded">
          <div class="text-sm text-gray-600">Sync Status</div>
          <div class="text-2xl font-bold text-gray-800" id="sync-status">Idle</div>
        </div>
        <div class="bg-gray-50 p-4 rounded">
          <div class="text-sm text-gray-600">Storage Used</div>
          <div class="text-2xl font-bold text-gray-800" id="storage-used">0%</div>
        </div>
      </div>
    </div>

    <!-- Test Actions -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">Test Actions</h2>
      
      <div class="space-y-4">
        <!-- Simulate Offline -->
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded">
          <div>
            <h3 class="font-semibold">Simulate Offline Mode</h3>
            <p class="text-sm text-gray-600">Use browser DevTools > Network > Offline</p>
          </div>
          <button onclick="alert('Open DevTools (F12) > Network Tab > Select Offline')" 
                  class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
            Instructions
          </button>
        </div>

        <!-- Queue Test Request -->
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded">
          <div>
            <h3 class="font-semibold">Queue Test Request</h3>
            <p class="text-sm text-gray-600">Add a test request to offline queue</p>
          </div>
          <button onclick="queueTestRequest()" 
                  class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
            Queue Request
          </button>
        </div>

        <!-- Save Test Data -->
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded">
          <div>
            <h3 class="font-semibold">Save Test Hazard Report</h3>
            <p class="text-sm text-gray-600">Save a hazard report to IndexedDB</p>
          </div>
          <button onclick="saveTestHazard()" 
                  class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
            Save Report
          </button>
        </div>

        <!-- Sync Queue -->
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded">
          <div>
            <h3 class="font-semibold">Sync Offline Queue</h3>
            <p class="text-sm text-gray-600">Manually trigger sync (requires online)</p>
          </div>
          <button onclick="manualSync()" 
                  class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
            Sync Now
          </button>
        </div>

        <!-- Clear Queue -->
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded">
          <div>
            <h3 class="font-semibold">Clear Offline Queue</h3>
            <p class="text-sm text-gray-600">Remove all queued requests</p>
          </div>
          <button onclick="clearQueue()" 
                  class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
            Clear Queue
          </button>
        </div>

        <!-- View Cache -->
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded">
          <div>
            <h3 class="font-semibold">View IndexedDB Data</h3>
            <p class="text-sm text-gray-600">Open DevTools > Application > IndexedDB</p>
          </div>
          <button onclick="viewIndexedDB()" 
                  class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
            View Data
          </button>
        </div>
      </div>
    </div>

    <!-- Event Log -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-800">Event Log</h2>
        <button onclick="clearLog()" class="text-sm text-gray-600 hover:text-gray-800">
          Clear Log
        </button>
      </div>
      <div id="event-log" class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm h-64 overflow-y-auto">
        <div>Waiting for events...</div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="mt-6 text-center">
      <a href="./features_pages/updated-home-page.html" 
         class="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
        Go to Main App
      </a>
    </div>
  </div>

  <!-- Scripts -->
  <script src="./offline-db.js"></script>
  <script src="./offline-ui.js"></script>
  <script src="./api.client.js"></script>

  <script>
    // Log function
    function log(message, type = 'info') {
      const logEl = document.getElementById('event-log');
      const time = new Date().toLocaleTimeString();
      const color = type === 'error' ? 'text-red-400' : 
                    type === 'success' ? 'text-green-400' : 
                    type === 'warning' ? 'text-yellow-400' : 'text-blue-400';
      
      const entry = document.createElement('div');
      entry.className = color;
      entry.textContent = `[${time}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function clearLog() {
      document.getElementById('event-log').innerHTML = '<div>Log cleared.</div>';
    }

    // Update status
    function updateStatus() {
      const online = navigator.onLine;
      const statusDot = document.getElementById('status-dot');
      const statusText = document.getElementById('status-text');
      
      statusDot.className = 'status-indicator ' + (online ? 'status-online' : 'status-offline');
      statusText.textContent = online ? 'Online' : 'Offline';
      statusText.className = 'text-lg font-semibold ' + (online ? 'text-green-600' : 'text-red-600');

      // Update queue status
      if (typeof getOfflineQueueStatus === 'function') {
        const status = getOfflineQueueStatus();
        document.getElementById('queue-length').textContent = status.queueLength;
        document.getElementById('sync-status').textContent = status.syncInProgress ? 'Syncing...' : 'Idle';
      }
    }

    // Update storage
    async function updateStorage() {
      if (typeof offlineDB !== 'undefined') {
        try {
          const estimate = await offlineDB.getStorageEstimate();
          if (estimate) {
            document.getElementById('storage-used').textContent = estimate.percentUsed + '%';
          }
        } catch (e) {
          console.error('Storage estimate failed:', e);
        }
      }
    }

    // Test actions
    async function queueTestRequest() {
      log('Queuing test request...', 'info');
      try {
        await offlineDB.queueRequest('/api/v1/test', 'POST', JSON.stringify({ test: true }), {});
        log('Test request queued successfully', 'success');
        updateStatus();
      } catch (e) {
        log('Failed to queue request: ' + e.message, 'error');
      }
    }

    async function saveTestHazard() {
      log('Saving test hazard report...', 'info');
      try {
        await offlineDB.saveHazardReport({
          description: 'Test hazard - unsafe condition',
          location: 'Test Zone A',
          severity: 'medium',
          timestamp: Date.now()
        });
        log('Test hazard report saved', 'success');
        updateStorage();
      } catch (e) {
        log('Failed to save hazard: ' + e.message, 'error');
      }
    }

    async function manualSync() {
      if (!navigator.onLine) {
        log('Cannot sync - you are offline', 'warning');
        return;
      }
      log('Starting manual sync...', 'info');
      try {
        if (typeof syncOfflineQueue === 'function') {
          await syncOfflineQueue();
          log('Manual sync completed', 'success');
        }
      } catch (e) {
        log('Sync failed: ' + e.message, 'error');
      }
    }

    async function clearQueue() {
      if (confirm('Clear all queued requests? This cannot be undone.')) {
        log('Clearing offline queue...', 'warning');
        try {
          if (typeof clearOfflineQueue === 'function') {
            await clearOfflineQueue();
            log('Queue cleared', 'success');
            updateStatus();
          }
        } catch (e) {
          log('Failed to clear queue: ' + e.message, 'error');
        }
      }
    }

    function viewIndexedDB() {
      log('Opening DevTools IndexedDB viewer...', 'info');
      alert('1. Open DevTools (F12)\n2. Go to Application tab\n3. Expand IndexedDB\n4. Select SurakshaSathiDB');
    }

    // Event listeners
    window.addEventListener('online', () => {
      log('Connection restored - ONLINE', 'success');
      updateStatus();
    });

    window.addEventListener('offline', () => {
      log('Connection lost - OFFLINE', 'error');
      updateStatus();
    });

    document.addEventListener('connection-status-changed', (e) => {
      log(`Connection status changed: ${e.detail.online ? 'ONLINE' : 'OFFLINE'}`, 
          e.detail.online ? 'success' : 'warning');
    });

    document.addEventListener('request-queued', (e) => {
      log(`Request queued: ${e.detail.method} ${e.detail.endpoint}`, 'info');
      updateStatus();
    });

    document.addEventListener('sync-completed', (e) => {
      log(`Sync completed: ${e.detail.successCount} succeeded, ${e.detail.failCount} failed`, 
          e.detail.failCount > 0 ? 'warning' : 'success');
      updateStatus();
    });

    // Initialize
    async function init() {
      log('Initializing offline features test page...', 'info');
      
      // Register service worker
      if ('serviceWorker' in navigator) {
        try {
          const reg = await navigator.serviceWorker.register('./sw.js');
          log('Service Worker registered', 'success');
        } catch (e) {
          log('Service Worker registration failed: ' + e.message, 'error');
        }
      }

      // Initialize offline DB
      if (typeof offlineDB !== 'undefined') {
        try {
          await offlineDB.init();
          log('IndexedDB initialized', 'success');
        } catch (e) {
          log('IndexedDB initialization failed: ' + e.message, 'error');
        }
      }

      updateStatus();
      updateStorage();
      setInterval(updateStatus, 2000);
      setInterval(updateStorage, 5000);
      
      log('Ready to test offline features!', 'success');
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>

</body>
</html>
